<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
      xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      xmlns:c="http://java.sun.com/jstl/core"
      template="/layout/template_new.xhtml">

<ui:param name="title" value="#{messages['dispensing.new']}" />

<ui:param name="topmenu" value="1" />
<ui:param name="labelstyle" value="width:220px;" />

<ui:define name="head">
<style>
.col1 {  width:400px; }
</style>
</ui:define>

<ui:define name="content">
<s:decorate template="/layout/unitsel.xhtml">

<h:form id="main" styleClass="form1"> 

	<div class="form-content">

    <s:decorate template="/layout/dateedit.xhtml" >
    	<ui:define name="label">#{messages['meds.dispensing.date']}:</ui:define>
    	<ui:param name="edtid" value="edtdate" />
    	<ui:param name="datefield" value="#{caseDispensingUIHome.dispensingDate}" /> 
		<ui:param name="required" value="true" />
		<ui:param name="future" value="false" />
    </s:decorate>
	
	</div>

	<s:decorate template="/layout/casebody.xhtml">

    <a:repeat value="#{caseDispensingUIHome.sources}" var="s">
    <h2>#{s.source}</h2>
   		<table id="tblmed" class="table1">
   		<tr>
   			<th>
   				#{messages['Medicine']}
   			</th>
   			<th>
   				#{messages['Batch.expiryDate']}
   			</th>
   			<th>
   				#{messages['Batch.remainingQuantity']}
   			</th>
   			<th>
   				#{messages['MedicineDispensing.quantity']}
   			</th>
   		</tr>
    	<a:repeat value="#{s.medicines}" var="med">
   		<tr class="highlight">
   			<td colspan="2" class="col1">
   				<div class="medicine-icon" />
				<h:outputText value="#{med.medicine}" />
			</td>
			<td align="right">
				<h:outputText value="#{med.item.quantity}" >
					<f:convertNumber pattern="#,###,##0"/>
				</h:outputText>
			</td>
			<td align="right">
				<a:commandLink value="#{messages['meds.dispensing.register']}" styleClass="link-small" 
					onclick="regDispClick(this,'#{med.rowId}');return false;"
					rendered="#{med.item.dispensingQuantity==0}"/>
				<div id="disptotal">
					<h:outputText value="#{med.item.dispensingQuantity}" rendered="#{med.item.dispensingQuantity>0}">
						<f:convertNumber pattern="#,###,##0"/>
					</h:outputText>
				</div>
				<h:outputText value="#{med.item.errorMessage}" rendered="#{not empty med.item.errorMessage}" styleClass="error"/>
			</td>
		</tr>
		<a:repeat value="#{med.batches}" var="b">
		<tr id="#{med.rowId}" style="display:#{med.item.dispensingQuantity>0?'block':'none'}">
			<td>
				<s:decorate template="/layout/batch.xhtml" >
					<ui:param name="batch" value="#{b.batchQuantity.batch}" />
				</s:decorate>
			</td>
			<td>
				<h:outputText value="#{b.batchQuantity.batch.expiryDate}" converter="localeDateConverter" />
			</td>
			<td align="right">
				<h:outputText value="#{b.batchQuantity.quantity}" >
					<f:convertNumber pattern="#,###,##0"/>
				</h:outputText>
			</td>
			<td align="right">
				<h:inputText value="#{b.dispensingQuantity}" style="width:80px"/>
			</td>
		</tr>
		</a:repeat>
    	</a:repeat>
   		</table>
    </a:repeat>
	
    <div class="form-footer">
        <h:commandLink action="#{batchDispensingUIHome.saveDispensing}" styleClass="button" onclick="if (!disableButton(this)) return false" >
        	<span>#{messages['form.save']}</span>
        </h:commandLink>  
        <s:link view="/medicines/index.xhtml" styleClass="button-alt" propagation="end" onclick="disableButton(this)">
        	<span>#{messages['form.cancel']}</span>
        </s:link>
    </div>

	</s:decorate>
</h:form>

<script type="text/javascript">
<!--
function detailsClick(elem, elemName) {
	var s = '#tblmed #' + elemName;
	try { s = eval(s);} catch(e){ }
	var row=jQuery(s);
	var bVisible=jQuery(elem).is(".collapse-icon");
	if (bVisible) {
		jQuery(elem).removeClass('collapse-icon').addClass('plus-icon');
		row.hide();
	}
	else {
		jQuery(elem).removeClass('plus-icon').addClass('collapse-icon');
		row.show();
	}
}
function regDispClick(anchor,elemName) {
	var elem=jQuery(anchor).closest("tr").find(".plus-icon").get(0);
	jQuery(anchor).hide();
	detailsClick(elem,elemName);
}
-->
</script>

</s:decorate>

</ui:define>

</ui:composition>  
