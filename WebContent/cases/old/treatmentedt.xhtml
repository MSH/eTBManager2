<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
      xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      template="#{workspaceViewService.templatePage}">

<ui:param name="title" value="#{messages['cases.regs']}" />

<ui:param name="topmenu" value="0" />
<ui:param name="waitdlg" value="1" />

<ui:param name="labelstyle" value="width:140px" />

<ui:define name="body">

<s:decorate template="/layout/casebody.xhtml">
	<a:form id="formtreat">
    <table width="100%">
    <tr><td>

	<s:decorate template="/layout/edit.xhtml">
    	<ui:define name="label">#{messages['TbCase.diagnosisDate']}:</ui:define>
    	<h:outputText value="#{tbCase.diagnosisDate}"  converter="localeDateConverter"/>
	</s:decorate>

	<div style="float:right;text-align:right;">
		<a:commandLink value="#{messages['cases.newregimen']}" action="#{caseRegimenHome.startNewRegimen}"
			reRender="newregform"
			oncomplete="showNewRegimenDlg();"/>
	</div>

	<div class="paragraph">#{messages['cases.healthUnit']}</div>
	<s:decorate template="/layout/tbselection.xhtml" style="margin-bottom:10px;">
    	<ui:define name="label">#{messages['cases.healthUnit']}:</ui:define>
    	<ui:param name="tbunitselection" value="#{treatmentHealthUnitHome.tbunitselection}" />
    	<ui:param name="required" value="true" />
	</s:decorate>

	<s:decorate template="/layout/display.xhtml" rendered="#{treatmentHealthUnitHome.managed}">
    	<ui:define name="label">#{messages['global.period']}:</ui:define>
		<h:outputText value="#{treatmentHealthUnit.iniDate}" converter="periodConverter" >
			<f:param name="endDate" value="#{treatmentHealthUnit.endDate}"/>
		</h:outputText>
		<br/>
		<a:commandLink value="#{messages['cases.regimens.changeperiod']}" 
			action="#{treatmentHealthUnitHome.startHealthUnitPeriodChanging}"
			reRender="datesdata"
			oncomplete="showDatesDlg();" 
			style="font-size:10px"
			rendered="false"/>
	</s:decorate>

	<h:panelGroup id="pnlregimens">
		<a:repeat value="#{treatmentHealthUnit.sortedRegimens}" var="r">
		<table width="100%" cellpadding="2" cellspacing="0" style="margin-top:35px;margin-bottom:1px;border:2px solid #d0d0d0;">
		<tr><td style="background-color:#e0e0e0" height="30px">
				<a:commandLink value="#{messages['cases.regimens.changeperiod']}" 
					style="font-size:10px;float:right;"
					action="#{caseRegimenHome.startPeriodChanging(r)}"
					reRender="regdatesdata"
					oncomplete="showRegDatesDlg();"
					/>
				<span style="margin-right:10px;"><b>#{messages['global.period']}:</b></span>
				<h:outputText value="#{r.iniDate}" converter="periodConverter">
					<f:param name="endDate" value="#{r.endDate}"/>
				</h:outputText>
				<br/>
		</td></tr>
		<tr><td style="background-color:#fbfbfb;padding:4px;">

			<div style="float:right;text-align:right;">
				<a:commandLink value="#{messages['form.remove']}" 
					action="#{treatmentHealthUnitHome.removeRegimen(r)}" 
					onclick="if (!confirm('#{messages['form.confirm_remove']}')) return false;"
					reRender="formtreat"/>
				<br/>
				<a:commandLink value="#{messages['cases.regimens.addmed']}" 
					action="#{caseRegimenHome.initMedicineSelection(r)}"
					reRender="medpnl"
					ajaxSingle="true"
					oncomplete="showMedicinesDlg();"/>
				<br/>
				<a:commandLink value="#{messages['cases.regimens.split']}"
					reRender="splitpnl"	
					action="#{splitRegimenHome.selectCaseRegimen(r)}"
					oncomplete="Richfaces.showModalPanel('splitdlg');"/>
			</div>

			<s:decorate template="/layout/display.xhtml">
				<ui:define name="label">#{messages['Regimen']}:</ui:define>
				<h:selectOneMenu value="#{r.regimen}">
					<s:selectItems var="it" value="#{treatmentHealthUnitHome.regimens}" noSelectionLabel="-" label="#{it.name}"/>
					<s:convertEntity />
					<a:support event="onchange" action="#{treatmentHealthUnitHome.changeRegimen(r)}" reRender="meds,messages" ajaxSingle="true"/>
				</h:selectOneMenu>
			</s:decorate>
			
			<s:decorate template="/layout/display.xhtml">
				<ui:define name="label">#{messages['Regimen.phase']}:</ui:define>
				<h:selectOneMenu value="#{r.phase}">
					<s:selectItems var="it" value="#{regimenPhases}" label="#{messages[it.key]}"/>
					<s:convertEnum />
					<a:support event="onchange" action="#{treatmentHealthUnitHome.changeRegimen(r)}" reRender="meds,messages" />
				</h:selectOneMenu>
			</s:decorate>
		</td></tr>
		<tr><td>

		<h:panelGroup id="meds">
		<h:outputText value="#{messages['edtrec.nomedicine']}" rendered="#{empty r.medicines}" styleClass="warn"/>
		<h:dataTable value="#{r.medicines}" var="m" width="100%" styleClass="tabela" columnClasses="coll,colc,colc,colc"  
		   rowClasses="lin1,lin2" style="clear:left;" rendered="#{not empty r.medicines}">
		<h:column>
			<f:facet name="header">#{messages['Medicine']}</f:facet>
			#{m.medicine}
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['PrescribedMedicine.doseUnit']}</f:facet>
			<h:inputText value="#{m.doseUnit}" id="dose" style="width:60px">
				<f:validateLongRange minimum="1" maximum="10"/>
			</h:inputText>
			<h:message for="dose" styleClass="erro" />
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['PrescribedMedicine.frequency']}</f:facet>
			<h:selectOneMenu value="#{m.frequency}" required="true" id="freq">
            	<f:selectItems value="#{frequencies}" />
			</h:selectOneMenu>
			<h:message for="freq" styleClass="erro" />
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['Source']}</f:facet>
			<h:selectOneMenu id="sourcei" value="#{m.source}" required="true">
            	<s:selectItems value="#{sources}" var="c" label="#{c.name}" noSelectionLabel="-" />
            	<s:convertEntity />
			</h:selectOneMenu>
			<h:message for="sourcei" styleClass="erro"/>
		</h:column>
		
		<h:column>
			<a:commandLink value="#{messages['form.remove']}" 
				action="#{caseRegimenHome.removeMedicine(r, m)}"
				reRender="pnlregimens"
				ajaxSingle="true" />
		</h:column>
		</h:dataTable>
		</h:panelGroup>
		</td>
		</tr></table>
		</a:repeat>
	</h:panelGroup>
	</td></tr>
    <tr><td align="right">
            <a:commandButton action="#{treatmentHealthUnitHome.persist}" value="#{messages['form.ok']}" styleClass="button" 
            	reRender="formtreat,messages" 
            	oncomplete="this.disabled=false;"
            	onclick="this.disabled=true;" />
            <h:commandButton action="cancel" value="#{messages['form.cancel']}" styleClass="button-cancel" immediate="true"/>
    </td></tr>
    
    </table>
    
	</a:form>
</s:decorate>


<p/>
	
<rich:modalPanel id="regdlg" height="200" width="370" zindex="2000">
	<f:facet name="header">
		<h:outputText value="#{messages['cases.setregimen']}" />
	</f:facet>
	<h:panelGroup id="regpnl">
	<h:form id="dlg" >
	<b>#{messages['admin.regimens']}</b><br/>
	<h:selectOneListbox value="#{caseRegimenHome.regimen}" style="width:98%;height:110px;">
		<s:selectItems value="#{treatmentHealthUnitHome.regimens}" var="r" label="#{r.name}" noSelectionLabel="- Individualized Regimen -" />
		<s:convertEntity />
	</h:selectOneListbox>
   	<br/>
   	<h:commandButton action="#{caseRegimenHome.defineRegimen}" value="#{messages['form.ok']}" styleClass="button" />
   	<s:button value="#{messages['form.cancel']}" onclick="javascript:Richfaces.hideModalPanel('regdlg'); return false;" styleClass="button-cancel"/>
	</h:form>
	</h:panelGroup>
</rich:modalPanel>


<rich:modalPanel id="splitdlg" height="200" width="400" zindex="2000" top="200px">
	<f:facet name="header">
		#{messages['cases.regimens.splittitle']}
	</f:facet>
	
	<h:panelGroup id="splitpnl">
	<a:form id="frmsplit" rendered="#{splitRegimenHome.caseRegimen!=null}">
	<a:region>
	<s:decorate id="dt" template="/layout/dateedit.xhtml">
    	<ui:define name="label">#{messages['cases.regimens.splitdate']}:</ui:define>
    	<ui:param name="required" value="true" /> 
    	<ui:param name="future" value="true" /> 
    	<ui:param name="datefield" value="#{splitRegimenHome.date}" /> 
	</s:decorate>
	<br/>
	#{messages['cases.regimens.splitmsg']}<br/>
	<s:decorate template="/layout/display.xhtml">
    	<ui:define name="label">#{messages['global.iniDate']}:</ui:define>
    	<h:outputText value="#{splitRegimenHome.caseRegimen.iniDate}" converter="localeDateConverter"/>
	</s:decorate>
	<s:decorate template="/layout/display.xhtml">
    	<ui:define name="label">#{messages['global.endDate']}:</ui:define>
    	<h:outputText value="#{splitRegimenHome.caseRegimen.endDate}"  converter="localeDateConverter"/>
	</s:decorate>
	<h:inputHidden id="maximunSeverity" value="#{facesContext.maximumSeverity.ordinal}" rendered="#{facesContext.maximumSeverity != null}" />
	<br/>
	<ui:include src="/layout/waitstatus.xhtml" />
   	<a:commandButton action="#{splitRegimenHome.slipt()}" value="#{messages['form.update']}" styleClass="button" 
   		reRender="pnlregimens,splitpnl" 
   		oncomplete="if (splitExecuted()) Richfaces.hideModalPanel('splitdlg');" 
   		onclick="if (!checkDate()) return false;"/>
   	<s:button value="#{messages['form.cancel']}" onclick="javascript:Richfaces.hideModalPanel('splitdlg'); return false;" styleClass="button-cancel"/>
	</a:region>

	</a:form>
	</h:panelGroup>

<script type="text/javascript">
function checkDate(obj) {
var edt = document.getElementById("frmsplit:dt:edtdateInputDate");
if (edt.value == '') {
	alert("Value required");
	return false;
}
return true;
} 
function splitExecuted() {
fld = document.getElementById("frmsplit:maximunSeverity");
return fld == null;
}
</script>
	
</rich:modalPanel>


<ui:include src="regimenperiod.xhtml" />

<ui:include src="newregimen.xhtml" />

<ui:include src="treatmentperiod.xhtml" />

<s:decorate template="/layout/medicineselection.xhtml" >
	<ui:param name="title" value="#{messages['form.selmeds']}" />
	<a:commandButton value="#{messages['form.ok']}" styleClass="button" action="#{caseRegimenHome.addMedicines}" 
		oncomplete="hideMedicinesDlg();" 
		reRender="formtreat"/>
</s:decorate>

</ui:define>

</ui:composition>  
