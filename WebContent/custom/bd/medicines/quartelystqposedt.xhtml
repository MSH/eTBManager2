<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
      xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      template="/layout/template_new.xhtml">
      
	<ui:param name="title" value="#{messages['Quarter.editQuartelyReport']}" />
	<ui:param name="topmenu" value="1" />
	<ui:param name="labelstyle" value="width:210px;" />
	<ui:param name="left" value="0" />
	
	<ui:define name="head">
	<style type="text/css">
		.posAdjust{
			background-color: white;
		}
		.negAdjust{
			background-color: white;
		}
		.expired{
			background-color: white;
		}
  	</style>
	</ui:define>

	<ui:define name="naveg">
		<div class="item">
			<s:link value="#{messages['meds.inventory']}" view="/medicines/index.xhtml" propagation="none"/>
		</div>
		<div class="item selected">
			<s:link value="#{title}" propagation="none" />
		</div>
	</ui:define>
	
	<ui:define name="content" id="content">
	<s:decorate template="/layout/unitsel.xhtml" id="a">
	<h:form id="main">
	
	<div id="tablediv">
	<table class="table1">
		<tr>
			<th colspan="9" align="left"><h2>#{messages[quarterStockPositionReport.selectedQuarter.quarter.key]}/#{quarterStockPositionReport.selectedQuarter.year} - #{quarterStockPositionHome.editingMedicine.medicine}</h2></th>
		</tr>
		<tr>
			<th>#{messages['Batch']}</th>
			<th>#{messages['quarter.openbal']}</th>
			<th>#{messages['quarter.received']}</th>-
			<th>#{messages['quarter.posadjust']}</th>
			<th>#{messages['quarter.negadjust']}</th>
			<th>#{messages['manag.forecast.tabres2']}</th>
			<th>#{messages['quarter.expired']}</th>
			<th>#{messages['quarter.closbal']}</th>
			<th>#{messages['quarter.outofstk']}</th>
		</tr>
		<tr>
			<td><b>#{messages['global.total']}:</b></td>
			<td><h:inputText id="openbal" value="#{quarterStockPositionHome.editingMedicine.openingBalance}" readonly="true" style="background-color: lightgray;"/></td>
			<td><h:inputText id="received" value="#{quarterStockPositionHome.editingMedicine.received}" readonly="true" style="background-color: lightgray;"/></td>
			<td><h:inputText id="posadjust" readonly="true" style="background-color: lightgray;"/></td>
			<td>
				<h:inputText id="negadjust" readonly="true" style="background-color: lightgray;"/>
				<s:fragment rendered="#{quarterStockPositionHome.editingMedicine.nonNegativeAdjustments != 0}">
					<br/><h:outputText style="font-size:10px" value="#{messages['quarter.nonNegativeAdjustment']}: #{quarterStockPositionHome.editingMedicine.nonNegativeAdjustments}" />
				</s:fragment>
			</td>
			<td>
				<!-- if the unit dispense by patient, can't edit a dispensing with this form -->
				<h:inputText id="consumption" value="#{quarterStockPositionHome.editingMedicine.consumption}"  readonly="#{userSession.tbunit.patientDispensing}" 
					style="#{userSession.tbunit.patientDispensing ? 'background-color: lightgray;' : ''}" onkeyup="updateCloseBalTotal();" onkeypress="return numbersOnly(this,event);" />
			</td>
			<td><h:inputText id="expired" readonly="true" style="background-color: lightgray;"/></td>
			<td><h:inputText id="closbal" value="0" readonly="true" style="background-color: lightgray;"/></td>
			<td><h:inputText value="#{quarterStockPositionHome.editingMedicine.outOfStock}" onkeypress="return numbersOnly(this,event);"/></td>
		</tr>
		<a:repeat value="#{quarterStockPositionHome.editingMedicine.batchList}" var="x">
			<tr>
				<td><b>
					<h:outputText value="#{x.batch.expiryDate}" rendered="#{not empty x.batch.expiryDate}"/> <br/>
					<h:outputText style="font-size:10px" value="#{x.batch.batchNumber} #{x.batch.manufacturer}" rendered="#{(not empty x.batch.batchNumber) or (not empty x.batch.manufacturer)}"/> <br/> 
					<h:outputText style="font-size:10px" value="#{x.source.abbrevName.name1}" rendered="#{not empty x.source}"/> 
				</b></td>
				
				<td align="center"><h:outputText value=" - " /></td>
				
				<td align="center"><h:outputText value=" - " /></td>
				
				<td>
				   	<h:inputText styleClass="posAdjust" value="#{x.posAdjust}" onkeyup="updatePosAdjustTotal();"
				   		onkeypress="return numbersOnly(this,event);" />
				</td>
				
				<td>
					<h:inputText styleClass="negAdjust" value="#{x.negAdjust}" onkeyup="updateNegAdjustTotal();"
				   		onkeypress="return numbersOnly(this,event);" />
				</td>
				
				<td align="center"><h:outputText value=" - " /></td>
				
				<td>
					<h:inputText styleClass="expired" value="#{x.expired}" onkeyup="updateExpiredTotal();"
				   		onkeypress="return numbersOnly(this,event);" />
				</td>
				
				<td align="center"><h:outputText value=" - " /></td>
				
				<td align="center"><h:outputText value=" - " /></td>
			</tr>
		</a:repeat>
	
	</table>
	<br/>
	
	<h:outputText value="#{messages['quarter.savingalert']}" styleClass="error" rendered="#{not userSession.tbunit.patientDispensing}"/>
	<h:outputText value="#{messages['quarter.savingalert2']}" styleClass="error" rendered="#{userSession.tbunit.patientDispensing}"/>
	
	<br/>
	<a:commandLink action="#{quarterStockPositionHome.save}" styleClass="button" 
		onclick="if (!disableButton(this)) return false;">
		<span>#{messages['form.save']}</span>
	</a:commandLink>	
	<s:link view="/custom/bd/medicines/quartelystqpos.xhtml" styleClass="button-alt" onclick="disableButton(this)">
    	<span>#{messages['form.cancel']}</span>
	</s:link>
	
	</div>
	
	</h:form>
	</s:decorate>
	
	<script language="JavaScript" type="text/javascript">
	<!--
	updatePosAdjustTotal();
	updateNegAdjustTotal();
	updateExpiredTotal();
	updateCloseBalTotal();
	
	function updatePosAdjustTotal(){
		var num = 0;
		jQuery('#tablediv .posAdjust').each(function() {
			num += parseInt(jQuery(this).val(),10);
		});
		if(isNaN(num))
			num = 0;

		document.getElementById('a:main:posadjust').value = num;

		updateCloseBalTotal();
	}
	function updateNegAdjustTotal(){
		var num = 0;
		jQuery('#tablediv .negAdjust').each(function() {
			num += parseInt(jQuery(this).val(),10);
		});

		if(isNaN(num))
			num = #{quarterStockPositionHome.editingMedicine.nonNegativeAdjustments};

		document.getElementById('a:main:negadjust').value = num + #{quarterStockPositionHome.editingMedicine.nonNegativeAdjustments};

		updateCloseBalTotal();
	}
	function updateExpiredTotal(){
		var num = 0;
		jQuery('#tablediv .expired').each(function() {
			num += parseInt(jQuery(this).val(),10);
		});
		if(isNaN(num))
			num = 0;

		document.getElementById('a:main:expired').value = num;

		updateCloseBalTotal();
	}
	function updateCloseBalTotal(){
		var openbal = parseInt(document.getElementById('a:main:openbal').value);
		var received = parseInt(document.getElementById('a:main:received').value);
		var posadjust = parseInt(document.getElementById('a:main:posadjust').value);
		var negadjust = parseInt(document.getElementById('a:main:negadjust').value);
		var consumption = parseInt(document.getElementById('a:main:consumption').value);
		var expired = parseInt(document.getElementById('a:main:expired').value);

		var num = openbal + received + posadjust - negadjust - consumption - expired;

		if(isNaN(num))
			num = 0;
		
		document.getElementById('a:main:closbal').value = num;
	}
	-->
	</script>
	</ui:define>
</ui:composition>