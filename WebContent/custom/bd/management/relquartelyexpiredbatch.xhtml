<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:s="http://jboss.com/products/seam/taglib"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      xmlns:p="http://jboss.com/products/seam/pdf"
      template="/layout/template_new.xhtml">

<ui:param name="title" value="#{messages['quarter.expiringbatchlist']}" />

<ui:param name="topmenu" value="2" />
<ui:param name="labelstyle" value="width:180px;" />
<ui:param name="left" value="0" />

<ui:define name="naveg">
	<s:link value="#{messages['manag']}" view="/management/index.html" propagation="none" />
	<div class="item selected">
		<s:link value="#{title}" />
	</div>
</ui:define>

<ui:define name="content" id="content">
	<h1>#{title}</h1>
	<h:form id="main" prependId="false">

    <s:decorate template="/layout/edit.xhtml" >
    	<ui:define name="label">#{messages['Source']}:</ui:define>
		<h:selectOneMenu value="#{quarterBatchExpiringReport.source}">
            <s:selectItems value="#{sources.resultList}" var="c" label="#{c.abbrevName} - #{c.name}" noSelectionLabel="#{messages['form.noselection']}" />
            <s:convertEntity/>
		</h:selectOneMenu>
    </s:decorate>

	<s:decorate template="/layout/edit.xhtml">
		<ui:param name="redasterisk" value="true" />
    	<ui:define name="label">#{messages['Quarter']}:</ui:define>
		<h:selectOneMenu value="#{quarterBatchExpiringReport.selectedQuarter.quarter}">
  			<s:selectItems value="#{quarter}" var="r" label="#{messages[r.key]}" />
  			<s:convertEnum />
		</h:selectOneMenu>
		/
		<h:selectOneMenu value="#{quarterBatchExpiringReport.selectedQuarter.year}" id="year">
  			<s:selectItems value="#{quarterYears}" var="r" label="#{r}" />
		</h:selectOneMenu>
	</s:decorate>
	
	<s:decorate template="/layout/tbselection2.xhtml" id="tbseldiv">
		<ui:param name="unitlabel" value="#{messages['MedicalExamination.RefToUnit']}" />
	   	<ui:param name="tbunitselection" value="#{quarterBatchExpiringReport.tbunitselection}" />
	   	<ui:param name="noselectionlabel" value="#{messages['form.noselection']}" />
	</s:decorate>

   	<a:commandLink styleClass="button-alt" action="#{quarterBatchExpiringReport.refresh}" onclick="if (!disableButton(this)) return false;" reRender="main">
   		<span>#{messages['form.update']}</span>
   	</a:commandLink>
	
	<!-- Message for no units for the administrative unit selected -->
	<h:outputText styleClass="warn" value="#{messages['global.nounitfound']}" rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and empty quarterBatchExpiringReport.unitBatchDetails}"/>
	
	<!-- If exist units, this is the code -->
	<s:fragment rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and not empty quarterBatchExpiringReport.unitBatchDetails}">
	
	<!-- Alerts if there are units with the selected quarter opened -->
	<s:div style="padding:1px;display:block" rendered="#{not empty quarterBatchExpiringReport.pendCloseQuarterUnits}">
		<!-- When selecting an administrative unit -->
		<h:outputFormat styleClass="error" value="#{messages['quarter.openquarterunit']}" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit == null}">
			<f:param value="#{quarterBatchExpiringReport.pendCloseQuarterUnits.size()}" />
		</h:outputFormat>
		<a:commandLink value=" #{messages['global.clicktoseelist']}" onclick="showOpenQuarterunitList();" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit == null}"/>

		<!-- When selecting a specific unit -->
		<h:outputText styleClass="error" value="#{messages['quarter.openquarterunit2']}" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit != null}"/>
	</s:div>
	
	<!-- Alerts if there are units with the medicine control not started -->
	<s:div style="padding:1px;display:block" rendered="#{not empty quarterBatchExpiringReport.unitsNotInitialized}">
		<!-- When selecting an administrative unit -->
		<h:outputFormat styleClass="error" value="#{messages['quarter.notinitializedunit']}" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit == null}">
			<f:param value="#{quarterBatchExpiringReport.unitsNotInitialized.size()}" />
		</h:outputFormat>
		<a:commandLink value=" #{messages['global.clicktoseelist']}" onclick="showNotInitializedUnts();" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit == null}"/>

		<!-- When selecting a specific unit -->
		<h:outputText styleClass="error" value="#{messages['quarter.notinitializedunit2']}" rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit != null}"/>
	</s:div>
	
	<br/>
	
	<a:repeat value="#{quarterBatchExpiringReport.unitBatchDetails}" var="unitD">
		<h2>
			<h:outputText value="#{unitD.unit}" />
			<h:outputText value=" (#{unitD.unit.adminUnit.getFullDisplayName2()})" style="font-size:11px"/>
		</h2>
		
		<!-- Message for no result -->
		<h:outputText value="#{messages['quarter.expiringbatchlist.noresultmsg']}" styleClass="warn" 
			rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and empty unitD.getBatchDetailsKeySet()}"/>
		
		<!-- Datatable of the result of the unit -->
		<h:dataTable value="#{unitD.getBatchDetailsKeySet()}" var="selBatch" rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and not empty unitD.getBatchDetailsKeySet()}" 
			styleClass="table1" columnClasses="colb,collb,colcb,colrb">
			<h:column>
				<f:facet name="header">#{messages['Medicine']}</f:facet>
				<h:outputText value="#{selBatch.medicine}" />
			</h:column>
			
			<h:column>
				<f:facet name="header">#{messages['Batch']}</f:facet>
				<h:outputText value="#{selBatch.batchNumber}" rendered="#{not empty selBatch.batchNumber}"/>
				<h:outputText value=" - " rendered="#{(not empty selBatch.batchNumber) and (not empty selBatch.manufacturer)}"/>
				<h:outputText value="#{selBatch.manufacturer}" rendered="#{not empty selBatch.manufacturer}"/>			
			</h:column>
			<h:column>
				<f:facet name="header">#{messages['Batch.expiryDate']}</f:facet>
				<h:outputText value="#{selBatch.expiryDate}" converter="localeDateConverter" />
			</h:column>
			
			<h:column>
				<f:facet name="header">#{messages['Movement.quantity']}</f:facet>
				<h:outputText value="#{unitD.batchInfo[selBatch]}" />
			</h:column>
		</h:dataTable>
		<hr/><br/>
	</a:repeat>

	<s:fragment rendered="#{quarterBatchExpiringReport.tbunitselection.tbunit == null and quarterBatchExpiringReport.tbunitselection.options.size() > 1}">
	<h2>
		Consolidated
	</h2>
	
	<!-- Message for no result of consolidated -->
	<h:outputText styleClass="warn" value="#{messages['quarter.expiringbatchlist.noresultmsg']}" 
			rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and empty quarterBatchExpiringReport.getBatchDetailsConsolidatedKeySet()}"/>
	
	<!-- Datatable of the result of the consolidated -->
	<h:dataTable value="#{quarterBatchExpiringReport.getBatchDetailsConsolidatedKeySet()}" var="selBatch" styleClass="table1" columnClasses="colb,collb,colcb,colrb"
		rendered="#{quarterBatchExpiringReport.isFiltersFilledIn() and not empty quarterBatchExpiringReport.getBatchDetailsConsolidatedKeySet()}">
		
		<h:column>
			<f:facet name="header">#{messages['Medicine']}</f:facet>
			<h:outputText value="#{selBatch.medicine}" />
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['Batch']}</f:facet>
			<h:outputText value="#{selBatch.batchNumber} - #{selBatch.manufacturer}" rendered="#{(not empty selBatch.batchNumber) or (not empty selBatch.manufacturer)}"/>
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['Batch.expiryDate']}</f:facet>
			<h:outputText value="#{selBatch.expiryDate}" converter="localeDateConverter"/>
		</h:column>
		
		<h:column>
			<f:facet name="header">#{messages['Movement.quantity']}</f:facet>
			<h:outputText value="#{quarterBatchExpiringReport.batchDetailsConsolidated[selBatch]}" />
		</h:column>
	</h:dataTable>
	</s:fragment>

	<!-- Modal panel with the units with no closed quarters -->
	<rich:modalPanel id="openQuarterunitList" autosized="true" width="700" zindex="2000" style="background-color:#F2F5F0">
		<f:facet name="header">
			<h:outputText value="#{messages['quarter.listopenquarterunit']}" />
		</f:facet>
		
		<h:outputFormat id="unitCount1" value="#{messages['meds.unitsfound']}" style="display:block;clear:both;font-weight:bold;">
			<f:param value="#{quarterBatchExpiringReport.pendCloseQuarterUnits.size()}" />
		</h:outputFormat>
		
		<div style="overflow:auto;width:98%;max-height:300px;min-height:80px;border: 1px gray solid;padding:6px;margin:0px;background-color:white;">
			<a:repeat value="#{quarterBatchExpiringReport.pendCloseQuarterUnits}" var="unit">
				<div class="#{unit.treatmentHealthUnit?'icon-hu':'icon-ds'}" />
				<h:outputText value="#{unit.name} - #{unit.adminUnit.fullDisplayName}" /><br/>	
			</a:repeat>
		</div>
		<div class="button-bar">
			<s:link styleClass="button-alt" onclick="hideOpenQuarterunitList(); return false;">
				<span>#{messages['form.close']}</span>
			</s:link>
		</div>
	</rich:modalPanel>
	
	<!-- Modal panel with the not initialized units. -->
	<rich:modalPanel id="notInitializedUnitsList" autosized="true" width="700" zindex="2000" style="background-color:#F2F5F0">
		<f:facet name="header">
			<h:outputText value="#{messages['quarter.listnotiniunits']}" />
		</f:facet>
		 
		<h:outputFormat id="unitCount2" value="#{messages['meds.unitsfound']}" style="display:block;clear:both;font-weight:bold;">
			<f:param value="#{quarterBatchExpiringReport.unitsNotInitialized.size()}" />
		</h:outputFormat>
		
		<div style="overflow:auto;width:98%;max-height:300px;min-height:80px;border: 1px gray solid;padding:6px;margin:0px;background-color:white;">
			<a:repeat value="#{quarterBatchExpiringReport.unitsNotInitialized}" var="unit">
				<div class="#{unit.treatmentHealthUnit?'icon-hu':'icon-ds'}" />
				<h:outputText value="#{unit.name} - #{unit.adminUnit.fullDisplayName}" /><br/>	
			</a:repeat>
		</div>
		<div class="button-bar">
			<s:link styleClass="button-alt" onclick="hideNotInitializedUnts(); return false;">
				<span>#{messages['form.close']}</span>
			</s:link>
		</div>
	</rich:modalPanel>
	
	<script type="text/javascript">
	function showOpenQuarterunitList() {
		Richfaces.showModalPanel('openQuarterunitList');
	}
	function hideOpenQuarterunitList() {
		Richfaces.hideModalPanel('openQuarterunitList');
	}
	function showNotInitializedUnts() {
		Richfaces.showModalPanel('notInitializedUnitsList');
	}
	function hideNotInitializedUnts() {
		Richfaces.hideModalPanel('notInitializedUnitsList');
	}
	</script>

	</s:fragment>
	
	</h:form>
</ui:define>


</ui:composition>  
