<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
 	  xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      template="..#{workspaceViewService.templatePage}">

<ui:param name="title" value="#{messages['manag.forecast.med']}" />

<ui:param name="topmenu" value="2" />
<ui:param name="waitdlg" value="1" />
<ui:param name="labelstyle" value="width:180px;" />
<ui:param name="pagewidth" value="850px" />
<ui:param name="left" value="0" />

<ui:define name="body">
<h:form id="main">

<table width="100%" style="border:2px solid #e0e0e0;border-collapse: collapse;">
<tr><td class="header">
	<img src="../img/forecast2.gif" style="float:left;padding-right:4px;" />
	<div style="float:right;">
		<a:commandLink value="#{messages['manag.forecast.new']}" style="margin-right:15px;" 
			action="#{forecastingHome.newForecasting}" reRender="main"
			onclick="if (!confirm('#{messages['form.confirmnew']}')) {return false;}" />
		<a:region>
		<a:commandLink value="#{messages['manag.forecast.load']}" style="margin-right:15px;" ajaxSingle="true"
			onclick="showLoadForecastingDlg()" reRender="fclist" action="#{forecastings.initLoading}" />
		</a:region>
	</div>
	#{forecastingHome.instance.name}
	<br/>
	<h:outputText value="#{forecasting.recordingDate}" style="font-size:9px;" converter="localeDateConverter" />
</td></tr>
<tr><td>

<table width="100%" style="border-collapse: collapse;">
<tr><td>
	<div style="float:right">
	<a:commandButton value="#{messages['manag.forecast.execute']}" styleClass="button" action="#{forecastingHome.execute}"/>
	<a:commandButton value="#{messages['form.save']}" styleClass="button" action="#{forecastingHome.persist}" 
	    reRender="messages" rendered="#{forecastingHome.managed}"/>
	<a:commandButton value="#{messages['form.save']}" styleClass="button" onclick="showForecastDlg();return false;"  
	    rendered="#{not forecastingHome.managed}"/>
	<s:button value="#{messages['form.cancel']}" view="/management/index.xhtml" styleClass="button-cancel" propagation="end"/>
	</div>

</td></tr>
<tr><td valign="top">
	<s:decorate template="/layout/roundrect.xhtml" style="margin-top:10px;">
		<ui:define name="header">
			<b>#{messages['form.filters']}</b>
		</ui:define>
		<ui:param name="showfooter" value="0" />

	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">#{messages['admin.medicines']}:</ui:define>
		<h:selectOneMenu value="#{forecasting.medicineLine}">
			<s:selectItems value="#{forecastingHome.medicineLines}" var="it" label="#{messages[it.key]}"  noSelectionLabel="#{messages['form.noselection']}" />
			<s:convertEnum />
			<a:support event="onchange" reRender="main" ajaxSingle="true" action="#{forecastingHome.refreshMedicineLine}"/>
		</h:selectOneMenu>
	</s:decorate>

	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">#{messages['manag.forecast.length']}:</ui:define>
		<h:selectOneMenu value="#{forecasting.length}">
			<f:selectItem itemLabel="-" itemValue="#{null}" />
			<f:selectItems value="#{forecastingHome.lengths}" />
		</h:selectOneMenu> (#{messages['global.months']})
	</s:decorate>

	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">#{messages['manag.forecast.bufferStock']}:</ui:define>
		<h:selectOneMenu value="#{forecasting.bufferStock}">
			<f:selectItems value="#{forecastingHome.lengths}"/>
		</h:selectOneMenu> (#{messages['global.months']})
	</s:decorate>

	<s:decorate template="/layout/edit.xhtml" >
		<ui:define name="label">#{messages['manag.forecast.leadtime']}:</ui:define>
		<h:selectOneMenu value="#{forecasting.leadTime}">
            <f:selectItems value="#{forecastingHome.leadTimeOptions}" />
		</h:selectOneMenu> (#{messages['global.months']})
	</s:decorate>

	<h:panelGroup id="pnlcontext">	
	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">#{messages['manag.forecast.context']}:</ui:define>
		<h:selectOneMenu value="#{forecasting.view}">
            <s:selectItems value="#{userViews}" var="it" label="#{messages[it.key]}" hideNoSelectionLabel="true"/>
         	<s:convertEnum />
         	<a:support event="onchange" reRender="pnlcontext" ajaxSingle="true" />
		</h:selectOneMenu>
	</s:decorate>

	<s:fragment rendered="#{forecasting.view == 'TBUNIT'}">
    <span class="paragraph">#{messages['TbUnit']}</span>
	<s:decorate template="/layout/tbselection.xhtml">
		<ui:param name="tbunitselection" value="#{forecastingHome.tbunitSelection}" />
	</s:decorate>
	</s:fragment>

	<s:fragment rendered="#{forecasting.view == 'ADMINUNIT'}">
	<s:decorate template="/layout/auselection.xhtml">
		<ui:param name="auselection" value="#{forecastingHome.adminUnitSelection}" />
	</s:decorate>
	</s:fragment>

	</h:panelGroup>

	</s:decorate>

	</td></tr>
</table>

<table width="100%" style="margin-top:10px;">
<tr><td valign="top" style="padding-right:20px;">

	<s:decorate template="/layout/roundrect.xhtml">
		<ui:define name="header">
			<a:commandLink value="#{messages['form.update']}" action="#{forecastingHome.initializeStockOnHand}" 
			   reRender="meds" style="float:right;"/>
			<b>#{messages['admin.medicines']}</b>
		</ui:define>
		<ui:param name="showfooter" value="0" />
		
		<h:panelGroup id="meds">
		<h:dataTable value="#{forecastingHome.forecastingMedicines}" var="r" styleClass="tabela4" style="clear:left;" 
			rowClasses="lin1,lin2" columnClasses="coll,colr,colr,colr">
			<h:column>
				<f:facet name="header">
					#{messages['Medicine']}
				</f:facet>
				#{r.medicine}
			</h:column>

			<h:column>
				<f:facet name="header">
					#{messages['manag.forecast.stockonhand']}
				</f:facet>
				<h:inputText value="#{r.stockOnHand}" style="width:60px;" />
			</h:column>

			<h:column>
				<f:facet name="header">
					#{messages['manag.forecast.stockonorder']}
				</f:facet>
				<h:inputText value="#{r.stockOnOrder}" style="width:60px;" />
			</h:column>

			<h:column>
				<f:facet name="header">
					#{messages['global.unitPrice']}
				</f:facet>
				<h:inputText value="#{r.unitPrice}" style="width:60px;" converter="currencyConverter" />
			</h:column>
		</h:dataTable>
		</h:panelGroup>
		
	</s:decorate>
	
</td><td valign="top">

	<s:decorate template="/layout/roundrect.xhtml" style="margin-bottom:10px;">
		<ui:define name="header">
			<b>#{messages['manag.forecast.newcases']}</b>
		</ui:define>
		<ui:param name="showfooter" value="0" />

		<s:decorate template="/layout/edit.xhtml" style="display:block;">
			<ui:define name="label">#{messages['manag.forecast.numnewcases']}:</ui:define>
			<h:inputText value="#{forecasting.numNewCases}" style="width:60px;margin-right:10px;" />
			<h:selectOneMenu value="#{forecasting.newCasesFreq}" >
				<s:selectItems var="s" value="#{forecastNewCasesFreq}" label="#{messages[s.key]}" hideNoSelectionLabel="-"/>
				<s:convertEnum />
			</h:selectOneMenu>
		</s:decorate>
		
		<h:dataTable value="#{forecasting.regimens}" var="r" styleClass="tabela4" style="clear:left;" rowClasses="lin1,lin2" columnClasses="col,colr,colr">
			<h:column>
				<f:facet name="header">
					#{messages['Regimen']}
				</f:facet>
				#{r.regimen.name}
			</h:column>

			<h:column>
				<f:facet name="header">
					#{messages['manag.forecast.percreg']}
				</f:facet>
				<h:inputText value="#{r.percNewCases}" style="width:70px;">
				</h:inputText>
			</h:column>

			<h:column rendered="false">
				<f:facet name="header">
					#{messages['manag.forecast.numcasesreg']}
				</f:facet>
				<h:outputText value="#{r.percNewCases}" >
					<f:convertNumber pattern="#,###,##0"/>
				</h:outputText> 
			</h:column>
		</h:dataTable>
		
	</s:decorate>

	<s:decorate template="/layout/roundrect.xhtml" style="margin-bottom:10px;">
		<ui:define name="header">
			<b>#{messages['manag.forecast.cases']}</b>
		</ui:define>
		<ui:param name="showfooter" value="0" />
		
		<h:selectBooleanCheckbox value="#{forecasting.includeCases}" /> #{messages['manag.forecast.includecases']} <br/>

		<h:selectBooleanCheckbox id="chkfixed" value="#{forecasting.defPrevCohort}" /> #{messages['manag.forecast.setprevcohorts']}
		<rich:jQuery selector="#chkfixed" query="click(function(){togglePanel(this, '#pnlexistingcohorts');})" />
		<script type="text/javascript">
function togglePanel(chk, divname) {
if (chk.checked)
	 jQuery(divname).show(500);
else jQuery(divname).hide(500);
}
		</script>

		<div id="pnlexistingcohorts" style="#{forecasting.defPrevCohort?'':'display:none;'}">
		<s:decorate template="/layout/edit.xhtml" style="display:block;">
			<ui:define name="label">#{messages['manag.forecast.initialcohort']}:</ui:define>
			<h:selectOneMenu value="#{forecasting.firstCohort}" >
				<f:selectItem itemLabel="-" itemValue="#{0}" />
				<f:selectItems value="#{forecastingHome.lengths}"/>
			</h:selectOneMenu>
		</s:decorate>

		<s:decorate template="/layout/edit.xhtml" style="display:block;">
			<ui:define name="label">#{messages['manag.forecast.numnewcases']}:</ui:define>
			<h:inputText value="#{forecasting.numCasesCohort}" style="width:60px;margin-right:10px;" />
			<h:selectOneMenu value="#{forecasting.cohortsFreq}" >
				<s:selectItems var="s" value="#{forecastNewCasesFreq}" label="#{messages[s.key]}" hideNoSelectionLabel="-"/>
				<s:convertEnum />
			</h:selectOneMenu>
		</s:decorate>
		
		<h:dataTable value="#{forecasting.regimens}" var="r" styleClass="tabela4" style="clear:left;" rowClasses="lin1,lin2" columnClasses="col,colr,colr">
			<h:column>
				<f:facet name="header">
					#{messages['Regimen']}
				</f:facet>
				#{r.regimen.name}
			</h:column>

			<h:column>
				<f:facet name="header">
					#{messages['manag.forecast.percreg']}
				</f:facet>
				<h:inputText value="#{r.percCasesCohort}" style="width:70px;">
				</h:inputText>
			</h:column>
		</h:dataTable>
		</div>
		
	</s:decorate>

</td></tr></table>

</td></tr>
</table>

<s:fragment rendered="#{not forecastingHome.managed}">
<script type="text/javascript">
function showForecastDlg() {
	Richfaces.showModalPanel('saveforecastdlg');
	document.getElementById("main:newfor:edtname").focus();
}
function hideForecastDlg() {
	Richfaces.hideModalPanel('saveforecastdlg');
}
function validateNewForecasting() {
	edt = document.getElementById("main:newfor:edtname");
	if (edt == null)
		return false;
	if (edt.value == '')
		return false;
	return true;
}
</script>
<rich:modalPanel id="saveforecastdlg" height="150" width="450" >
	<f:facet name="header">
		#{messages['manag.forecast.new']}: #{messages['form.save']}
	</f:facet>
	<h:panelGroup id="pnlfordlg" >
	<ui:param name="labelstyle" value="width:80px;" />
	<s:decorate template="/layout/edit.xhtml" id="newfor">
		<ui:define name="label">#{messages['form.name']}:</ui:define>
		<h:inputText id="edtname" value="#{forecastingHome.instance.name}" style="width:300px;"/>
	</s:decorate>
	<div style="float:right;margin-top:20px;">
	<a:commandButton value="#{messages['form.ok']}" styleClass="button" 
		action="#{forecastingHome.persist}" reRender="messages"
		onclick="if (!validateNewForecasting()) {alert('#{messages['form.name']}: #{messages['javax.faces.component.UIInput.REQUIRED']}'); return false;} " 
		oncomplete="this.disabled=false;hideForecastDlg();" ignoreDupResponses="true">
		<a:actionparam noEscape="true" assignTo="#{forecastingHome.instance.name}" value="document.getElementById('main:newfor:edtname').value" />
	</a:commandButton>

	<a:commandButton value="#{messages['form.cancel']}" styleClass="button-cancel" 
	    onclick="hideForecastDlg(); return false;" />
	</div>
	</h:panelGroup> 
</rich:modalPanel>
</s:fragment>

</h:form>

<rich:modalPanel id="loadfordlg" height="400" width="490" zindex="2000" style="background-color:#F2F5F0">
	<f:facet name="header">#{messages['manag.forecast.load']}</f:facet>
	<h:form id="frmunit" style="margin:0px">
	<div style="overflow: auto; width: 98%; height: 280px;border: 1px gray solid; padding:0px; margin: 0px;background-color:white;">
	<h:panelGroup id="fclist">
		<s:fragment rendered="#{not forecastings.loading}">
			<div style="padding: 10px; margin-top: 40px; margin-left: 120px; margin-right: 120px;margin-bottom:60px;border:4px double #b0b0b0;">
			<h:graphicImage value="/img/spinner.gif" />
			<span style="color:#d0d0d0">#{messages['global.wait']}</span>
			</div>
		</s:fragment>
		<s:fragment rendered="#{forecastings.loading}">
		<h:dataTable value="#{forecastings.resultList}" var="it" width="100%" >
			<h:column>
				<img src="../img/forecast2.gif" style="float:left;padding:4px;"/>
				<s:link view="/management/medforecast.xhtml" value="#{it.name}">
					<f:param name="id" value="#{it.id}"/>
				</s:link>
  				<br/>
  				<h:outputText value="#{it.recordingDate}" >
  					<f:convertDateTime timeZone="#{timezones.default}" type="both"/>
  				</h:outputText>
			</h:column>
		</h:dataTable>
		</s:fragment>
	</h:panelGroup>
	</div>
	</h:form>
	<s:button value="#{messages['form.cancel']}" styleClass="button-cancel" onclick="hideLoadForecastingDlg(); return false;"/>
</rich:modalPanel>
<script type="text/javascript">
function showLoadForecastingDlg() {
	Richfaces.showModalPanel('loadfordlg');
}
function hideLoadForecastingDlg() {
	Richfaces.hideModalPanel('loadfordlg');
}
</script>

</ui:define>

</ui:composition>  

