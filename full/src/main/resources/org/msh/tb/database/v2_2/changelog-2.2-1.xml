<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="2.2.1" author="rmemoria">
        <createTable tableName="gxalertdata">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" />
            </column>
            <column name="systemName" type="varchar(255)"></column>
            <column name="hostId" type="varchar(255)"></column>
            <column name="assay" type="varchar(255)"></column>
            <column name="assayVersion" type="varchar(10)"></column>
            <column name="sampleId" type="varchar(45)"></column>
            <column name="patientId" type="varchar(255)"></column>
            <column name="user" type="varchar(255)"></column>
            <column name="testStartedOn" type="datetime"></column>
            <column name="testEndedOn" type="datetime"></column>
            <column name="reagentLotId" type="varchar(255)"></column>
            <column name="cartridgeExpirationDate" type="datetime"></column>
            <column name="cartridgeSerial" type="varchar(255)"></column>
            <column name="moduleSerial" type="varchar(255)"></column>
            <column name="instrumentSerial" type="varchar(255)"></column>
            <column name="softwareVersion" type="varchar(255)"></column>
            <column name="resultIdMtb" type="int"></column>
            <column name="resultIdRif" type="int"></column>
            <column name="deviceSerial" type="varchar(255)"></column>
            <column name="notes" type="varchar(255)"></column>
            <column name="messageSentOn" type="datetime"></column>
            <column name="assayHostTestCode" type="varchar(255)"></column>
            <column name="resultText" type="varchar(255)"></column>
            <column name="computerName" type="varchar(255)"></column>
            <column name="recordDate" type="datetime"></column>
            <column name="lastTransaction_ID" type="int"></column>
            <column name="WORKSPACE_ID" type="int">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2.2.2" author="rmemoria">
        <sql>update sys_user set ulaAccepted=false where ulaAccepted is null</sql>
    </changeSet>

    <changeSet id="2.2-1.3" author="msantos">
        <sql>ALTER TABLE tbcase DROP COLUMN rifampcinResistance</sql>
    </changeSet>

    <!-- updates field case definition field according to exams -->
    <changeSet id="2.2-1.4" author="msantos">
        <sql>
            update tbcase
            set casedefinition = 1
            where diagnosisType = 1;


            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is null and
            exists (
            select e.case_id
            from exammicroscopy e
            where
            e.case_id = tbcase.id and
            e.result in (1,2,3,4,5) and
            e.id = (select max(id)
            from exammicroscopy e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from exammicroscopy e2
            where e2.case_id = e1.case_id))
            );

            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is not null and
            exists (
            select e.case_id
            from exammicroscopy e
            where
            e.case_id = tbcase.id and
            e.result in (1,2,3,4,5) and
            e.id = (select max(id)
            from exammicroscopy e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from exammicroscopy e2
            where e2.case_id = e1.case_id and e2.datecollected &lt; tbcase.initreatmentdate))
            );


            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is null and
            exists (
            select e.case_id
            from examculture e
            where
            e.case_id = tbcase.id and
            e.result in (1,2,3,4,5) and
            e.id = (select max(id)
            from examculture e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from examculture e2
            where e2.case_id = e1.case_id))
            );

            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is not null and
            exists (
            select e.case_id
            from examculture e
            where
            e.case_id = tbcase.id and
            e.result in (1,2,3,4,5) and
            e.id = (select max(id)
            from examculture e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from examculture e2
            where e2.case_id = e1.case_id and e2.datecollected &lt; tbcase.initreatmentdate))
            );


            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is null and
            exists (
            select e.case_id
            from examxpert e
            where
            e.case_id = tbcase.id and
            e.result in (5) and
            e.id = (select max(id)
            from examxpert e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from examxpert e2
            where e2.case_id = e1.case_id))
            );

            update tbcase
            set casedefinition = 0
            where diagnosisType = 1 and
            initreatmentdate is not null and
            exists (
            select e.case_id
            from examxpert e
            where
            e.case_id = tbcase.id and
            e.result in (5) and
            e.id = (select max(id)
            from examxpert e1
            where e1.case_id = e.case_id
            and e1.datecollected = (select max(datecollected)
            from examxpert e2
            where e2.case_id = e1.case_id and e2.datecollected &lt; tbcase.initreatmentdate))
            );
        </sql>
    </changeSet>

    <changeSet id="2.2-1.5" author="msantos">
        <addColumn tableName="tbcase">
            <column name="treatmentCategory" type="int" />
        </addColumn>
    </changeSet>

</databaseChangeLog>