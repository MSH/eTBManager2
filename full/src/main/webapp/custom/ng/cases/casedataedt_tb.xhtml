<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:s="http://jboss.com/products/seam/taglib"
                xmlns:rich="http://richfaces.ajax4jsf.org/rich" xmlns:a="http://richfaces.org/a4j">

    <div class="form-content">
        <h2>#{messages['cases.tbcasedata']}</h2>

        <table width="100%" style="border-collapse:collapse;">
            <tr><td colspan="2">
                <s:decorate template="/layout/editname.xhtml">
                    <ui:define name="label">#{messages['Patient.name']}:</ui:define>
                    <ui:param name="patientdata" value="#{tbcase.patient}" />
                    <ui:param name="redasterisk" value="#{true}" />
                </s:decorate>
            </td></tr>
            <tr><td colspan="2">
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['Patient.securityNumber']}:</ui:define>
                    <h:inputText id="edtsecnumber" value="#{tbcase.patient.securityNumber}" style="width:120px;" maxlength="10"></h:inputText>
                </s:decorate>
            </td></tr>
            <tr><td>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['TbCase.age']}:</ui:define>
                    <ui:param name="redasterisk" value="#{true}" />
                    <h:inputText id="edtage" value="#{tbcase.age}" style="width:80px;">
                        <f:validateLongRange minimum="0" maximum="150"/>
                    </h:inputText>
                </s:decorate>
            </td><td>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['Gender']}:</ui:define>
                    <ui:param name="redasterisk" value="#{true}" />
                    <h:selectOneMenu id="edtgender" value="#{tbcase.patient.gender}">
                        <s:selectItems value="#{genders}" var="it" label="#{messages[it.key]}" noSelectionLabel="-"/>
                        <s:convertEnum />
                    </h:selectOneMenu>
                </s:decorate>
            </td></tr>

            <tr><td colspan="2">
                <div class="paragraph">#{messages['cases.details.addressnotif']}</div>
            </td></tr>

            <tr><td colspan="2">
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['Address.completeAddress']}:</ui:define>
                    <ui:param name="redasterisk" value="true"/>
                    <h:inputTextarea id="edtaddr" value="#{tbcase.notifAddress.address}" style="width:300px;height:100px" />
                </s:decorate>
            </td></tr>

            <tr><td>
                <s:decorate template="/layout/auselection.xhtml">
                    <ui:param name="auselection" value="#{caseEditingHome.notifAdminUnit}" />
                    <ui:param name="requiredLevel" value="#{defaultWorkspace.patientAddrRequiredLevels}" />
                </s:decorate>
            </td></tr>

            <tr><td>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['Address.zipCode']}</ui:define>
                    <h:inputText id="edtzip" value="#{tbcase.notifAddress.zipCode}" maxlength="20" />
                </s:decorate>
            </td></tr>

            <tr><td colspan="2">
                <s:decorate template="/layout/edit.xhtml">
                    <ui:param name="labelstyle" value="width:600px;" />
                    <ui:define name="label">#{messages['TbCase.notifAddressChanged']}</ui:define>
                    <h:selectOneMenu id="addrChanged" value="#{tbcase.notifAddressChanged}" >
                        <f:selectItem itemLabel="#{messages['global.no']}" itemValue="#{false}"/>
                        <f:selectItem itemLabel="#{messages['global.yes']}" itemValue="#{true}"/>
                    </h:selectOneMenu>
                </s:decorate>

                <div id="curraddr" style="clear:both;">
                    <!-- <div class="paragraph">#{messages['cases.details.addresscurr']}</div> -->
                    <s:decorate template="/layout/edit.xhtml">
                        <ui:define name="label">#{messages['cases.details.addresscurr']}:</ui:define>
                        <h:inputTextarea value="#{tbcase.currentAddress.address}" style="width:300px;height:100px;margin-bottom:2px;" maxlength="100"/><br/>
                        <!-- <h:inputText value="#{tbcase.currentAddress.complement}" style="width:300px" maxlength="100"/> -->
                    </s:decorate>

                    <s:decorate template="/layout/edit.xhtml">
                        <ui:define name="label">#{messages['Address.zipCode']}</ui:define>
                        <h:inputText value="#{tbcase.currentAddress.zipCode}" maxlength="20" />
                    </s:decorate>

                    <table width="100%" style="border-collapse: collapse;">
                        <tr><td>
                            <s:decorate template="/layout/auselection.xhtml">
                                <ui:param name="auselection" value="#{caseEditingHome.currentAdminUnit}" />
                                <ui:param name="required" value="false" />
                            </s:decorate>
                        </td></tr>
                    </table>
                    <hr/>
                </div>
            </td></tr>
            <tr><td>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['TbCase.phoneNumber']}:</ui:define>
                    <h:inputText id="edtphone" value="#{tbcase.phoneNumber}" />
                </s:decorate>
            </td><td>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['TbCase.mobileNumber']}:</ui:define>
                    <h:inputText id="edtmob" value="#{tbcase.mobileNumber}" />
                </s:decorate>
            </td></tr>
            <tr><td>
                <s:decorate template="/layout/editfield.xhtml" >
                    <ui:define name="label">#{messages['TbField.OCCUPATION']}:</ui:define>
                    <ui:param name="id" value="edtoccupation" />
                    <ui:param name="field" value="#{tbcase.occupation}" />
                    <ui:param name="list" value="#{fieldsQuery.occupations}" />
                </s:decorate>
            </td><td>
                <s:decorate template="/layout/editfield.xhtml" >
                    <ui:define name="label">#{messages['TbField.MARITAL_STATUS']}:</ui:define>
                    <ui:param name="id" value="edtmaritalstatus" />
                    <ui:param name="field" value="#{tbcase.maritalStatus}" />
                    <ui:param name="list" value="#{fieldsQuery.maritalStatus}" />
                </s:decorate>
            </td></tr>
        </table>
    </div>

    <div class="form-content">

        <h2>#{messages['cases.details.case']}</h2>

        <table width="100%" style="border-collapse:collapse;">
            <tr><td style="padding-bottom:10px;">

                <div class="paragraph"><b>#{messages['TbCase.notificationUnit']}</b></div>
                <s:decorate template="/custom/ng/layout/tbselection.xhtml" >
                    <ui:param name="tbunitselection" value="#{caseEditingHome.tbunitselection}" />
                    <ui:param name="redasterisk" value="true" />
                    <ui:param name="idcbunits" value="cbnotifunit" />
                    <ui:param name="required" value="true" />
                </s:decorate>

                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['cases.historyAntiTBdrugs']}:</ui:define>
                    <ui:param name="labelstyle" value="width:390px;"/>
                    <h:selectOneMenu id="edtint" value="#{tbcase.intakeAntiTBDrugs}">
                        <s:selectItems var="it" value="#{yesNoList}" noSelectionLabel=" - " label="#{messages[it.key]}" />
                        <s:convertEnum />
                    </h:selectOneMenu>
                </s:decorate>

                <div id="intaketbduration">
                    <s:decorate template="/layout/edit.xhtml">
                        <ui:define name="label">#{messages['cases.durationweeks']}:</ui:define>
                        <ui:param name="labelstyle" value="margin-left: 229px;width: 160px;"/>
                        <h:selectOneMenu id="edtintduration" value="#{tbcase.intakeAntiTBDrugsDuration}">
                            <s:selectItems var="it" value="#{intakeAntiDrugsDuration}" noSelectionLabel="-" label="#{messages[it.key]}" />
                            <s:convertEnum />
                        </h:selectOneMenu>
                    </s:decorate>
                </div>

                <s:decorate template="/layout/editfield.xhtml" >
                    <ui:define name="label">#{messages['TbField.SOURCE_REFERRAL']}:</ui:define>
                    <ui:param name="required" value="false" />
                    <ui:param name="id" value="sr" />
                    <ui:param name="field" value="#{tbcase.sourceReferral}" />
                    <ui:param name="list" value="#{fieldsQuery.sourcesReferral}" />
                </s:decorate>

                <s:decorate template="/layout/dateedit.xhtml" >
                    <ui:define name="label">#{messages['TbCase.registrationDate']}:</ui:define>
                    <ui:param name="datefield" value="#{tbcase.healthunitRegistrationDate}" />
                    <ui:param name="future" value="false" />
                    <ui:param name="checkDeathDate" value="true" />
                    <ui:param name="edtid" value="edtregdate" />
                </s:decorate>

                <s:decorate template="/layout/edit.xhtml" >
                    <ui:define name="label">#{messages['TbCase.LGATBL']}:</ui:define>
                    <h:inputText value="#{tbcase.tbRegistrationNumber}" style="width:120px;" maxlength="10"></h:inputText>
                </s:decorate>

                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['PatientType']}:</ui:define>
                    <h:selectOneMenu id="patType" value="#{tbcase.patientType}">
                        <s:selectItems var="it" value="#{patientTypesTB}" noSelectionLabel="-" label="#{messages[it.key]}" />
                        <s:convertEnum />
                    </h:selectOneMenu>
                </s:decorate>

                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages['InfectionSite']}:</ui:define>
                    <h:selectOneMenu id="infectsite" value="#{tbcase.infectionSite}">
                        <s:selectItems var="it" value="#{infectionSites}" noSelectionLabel="-" label="#{messages[it.key]}" />
                        <s:convertEnum />
                    </h:selectOneMenu>
                </s:decorate>

                <rich:jQuery selector="#infectsite" query="change(function(){showExtrapulmonary(this); })" />
                <script type="text/javascript">
                    <!--
                    function showExtrapulmonary(cb) {
                        if (isExtrapulmonary(cb))
                            jQuery('#extrapul').show(500);
                        else jQuery('#extrapul').hide(500);
                        if (isPulmonary(cb))
                            jQuery('#pulmonary').show(500);
                        else jQuery('#pulmonary').hide(500);
                    }
                    function isExtrapulmonary(cb) {
                        return ((cb.selectedIndex == 2) || (cb.selectedIndex == 3));
                    }
                    -->
                </script>

                <div id="extrapul" style="clear:both;">
                    <div style="float:left">
                        <s:decorate template="/layout/editfield.xhtml" >
                            <ui:define name="label">#{messages['TbField.EXTRAPULMONARY_TYPES']}:</ui:define>
                            <ui:param name="id" value="edtextrap" />
                            <ui:param name="field" value="#{tbcase.extrapulmonaryType}" />
                            <ui:param name="list" value="#{fieldsQuery.extrapulmonaryTypes}" />
                        </s:decorate>
                    </div>

                    <div style="float:left">
                        <s:decorate template="/layout/editfield.xhtml" >
                            <ui:define name="label">#{messages['TbField.EXTRAPULMONARY_TYPES']}(2):</ui:define>
                            <ui:param name="id" value="edtextrap" />
                            <ui:param name="field" value="#{tbcase.extrapulmonaryType2}" />
                            <ui:param name="list" value="#{fieldsQuery.extrapulmonaryTypes}" />
                        </s:decorate>
                    </div>
                </div>

                <rich:jQuery selector="#infectsite" query="each(function(){ if (!isExtrapulmonary(this)) {jQuery('#extrapul').hide(); }})" />
                <rich:jQuery selector="#patType" query="each(function(){ if (!isPatientTypeOther(this)) {jQuery('#patientTypeOther').hide(); }})" />

            </td></tr>
        </table>
    </div>

    <!-- exams only for new suspects -->
    <s:fragment rendered="#{empty tbcase.id}">

        <div class="form-content">
            <h2>#{messages['cases.exammicroscopy']}</h2>
            <s:decorate template="templates/edtmicroscopy.xhtml"/>
        </div>



        <div class="form-content">
            <h2>#{messages['cases.examxpert']}</h2>
            <s:decorate template="templates/edtxpert.xhtml"/>
        </div>


        <div class="form-content">
            <h2>#{messages['cases.examculture']}</h2>
            <s:decorate template="templates/edtculture.xhtml"/>
        </div>

    </s:fragment>

    <div class="form-content">
        <h2>#{messages['manag.hivreport']}</h2>

        <s:decorate template="/layout/edit.xhtml" >
            <ui:define name="label">#{messages['cases.details.result']}:</ui:define>
            <ui:param name="redasterisk" value="true" />
            <h:selectOneMenu id="hivresult" value="#{tbcase.hivPosition}" >
                <s:selectItems value="#{hivpositions_ng}" var="it" noSelectionLabel=" - " label="#{messages[it.key]}" />
                <s:convertEnum />
            </h:selectOneMenu>
        </s:decorate>

        <div id="hivdata" style="#{tbcase.hivPosition == 'POSITIVE' ? '' : 'display:none'}">
            <s:decorate template="/layout/edit.xhtml" id="hivdetaildec" >
                <ui:define name="label">#{messages['TbCase.resultdate']}:</ui:define>
                <ui:param name="redasterisk" value="true" />
                <h:selectOneMenu id="hivdetail" value="#{tbcase.hivPositionDetail}" >
                    <s:selectItems value="#{hivpositiondetails_ng}" var="it" noSelectionLabel=" - " label="#{messages[it.key]}" />
                    <s:convertEnum />
                </h:selectOneMenu>
            </s:decorate>
        </div>

        <rich:jQuery selector="#hivresult" query="change( function(){ hivStatusChanged(this, 'hivdata'); })" />
    </div>

    <div class="form-content">
        <a:commandLink styleClass="button-alt" style="float:right"
                       action="#{contactsActionNG.newContact}"
                       reRender="pnlcontacts">
            <span>Add contact</span>
        </a:commandLink>
        <h2>#{messages['cases.contacts']}</h2>

        <h:panelGroup id="pnlcontacts">
            <s:fragment rendered="#{not empty contactsActionNG.contacts}" >
                <table width="100%" class="table1">
                    <tr>
                        <th></th>
                        <th align="left">
                            #{messages['TbContact.name']}
                        </th>
                        <th align="left">
                            #{messages['Gender']}
                        </th>
                        <th align="left">
                            #{messages['TbCase.age']}
                        </th>
                        <th align="left">
                            #{messages['TbContact.contactType']}
                        </th>
                        <th>
                            #{messages['TbContact.examined']}
                        </th>
                        <th align="left">
                            #{messages['TbContact.conduct']}
                        </th>
                    </tr>

                    <a:repeat value="#{contactsActionNG.contacts}" var="cont">
                        <tr>
                            <td align="center">
                                <a:commandLink onclick="removeContact(#{contactsActionNG.contacts.indexOf(cont)}); return false;"
                                               title="#{messages['form.remove']}" >
                                    <i class="icon-minus-sign-alt"></i>
                                </a:commandLink>
                            </td>
                            <td>
                                <s:decorate styleClass="label">
                                    <s:label value="#{messages['Patient.lastName']}" styleClass="over" />
                                    <h:inputText id="paclastname" value="#{cont.contactLastName}" style="width:80px;" />
                                </s:decorate>
                                <s:decorate styleClass="label">
                                    <s:label value="#{messages['Patient.firstname']}" styleClass="over" />
                                    <h:inputText id="pacname" value="#{cont.name}" style="width:80px;margin-right:6px;" required="#{required}"/>
                                </s:decorate>
                                <s:decorate styleClass="label">
                                    <s:label value="#{messages['Patient.middleName']}" styleClass="over" />
                                    <h:inputText id="pacmidname" value="#{cont.contactOtherName}" style="width:80px;margin-right:6px;" />
                                </s:decorate>
                            </td>
                            <td>
                                <h:selectOneMenu value="#{cont.gender}" required="false">
                                    <s:selectItems value="#{genders}" var="it" noSelectionLabel="-" label="#{messages[it.key]}" />
                                    <s:convertEnum />
                                </h:selectOneMenu>
                            </td>
                            <td>
                                <h:inputText value="#{cont.age}" style="width:50px"/>
                            </td>
                            <td>
                                <h:selectOneMenu value="#{cont.contactType}" required="false">
                                    <s:selectItems value="#{fieldsQuery.contactTypes}" var="s" noSelectionLabel="-" label="#{s.name}" />
                                    <s:convertEntity />
                                </h:selectOneMenu>
                            </td>
                            <td>
                                <h:selectOneMenu value="#{tbContactNG.examinated}" required="false">
                                    <f:selectItem itemLabel="#{messages['global.yes']}" itemValue="#{true}"/>
                                    <f:selectItem itemLabel="#{messages['global.no']}" itemValue="#{false}"/>
                                </h:selectOneMenu>
                            </td>
                            <td>
                                <h:selectOneMenu value="#{tbContactNG.conduct}" required="false">
                                    <s:selectItems value="#{fieldsQuery.contactConducts}" var="s" noSelectionLabel="-" label="#{s.name}" />
                                    <s:convertEntity />
                                </h:selectOneMenu>
                            </td>
                        </tr>
                    </a:repeat>
                </table>
            </s:fragment>

            <a:jsFunction name="removeContact" action="#{contactsActionNG.remove}" reRender="pnlcontacts">
                <a:actionparam name="param1" assignTo="#{contactsActionNG.removeIndex}" converter="javax.faces.Integer" />
            </a:jsFunction>
        </h:panelGroup>

    </div>

    <script type="text/javascript">
        <!--
        function examResultChanged(cb, elem, immediate) {
            if (cb.selectedIndex !== 0)
                jQuery('#'+ elem).slideDown(immediate?0:500)
            else jQuery('#' + elem).slideUp(immediate?0:500);
        }
        function hivStatusChanged(cb, elem, immediate) {
            if (cb.selectedIndex !== 1)
                jQuery('#'+ elem).slideUp(immediate?0:500)
            else {
                jQuery('#' + elem).slideDown(immediate ? 0 : 500);
            }
        }
        function isPatientTypeOther(cb) {
            return ((cb.selectedIndex >= 0) && (cb.options[cb.selectedIndex].value == 'OTHER'));
        }
        function showPatientTypeOther(cb) {
            if (isPatientTypeOther(cb))
                jQuery('#patientTypeOther').show(500);
            else jQuery('#patientTypeOther').hide(500);
        }
        function showCurrAddress(cb) {
            if (cb.selectedIndex == 0)
                jQuery('#curraddr').hide(500);
            else jQuery('#curraddr').show(500);
        }
        -->
    </script>
    <rich:jQuery selector="#addrChanged" query="change(function(){ showCurrAddress(this); })" />
    <rich:jQuery selector="#addrChanged" query="each(function(){ if (this.selectedIndex==0) jQuery('#curraddr').hide(); })" />


</ui:composition>