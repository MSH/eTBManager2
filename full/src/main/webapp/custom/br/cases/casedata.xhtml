<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
      xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"   
      xmlns:c="http://java.sun.com/jstl/core"
      template="/layout/template_new.xhtml">


<ui:param name="title" value="#{messages['cases.details']} - #{messages[tbcase.classification.key]}" />

<ui:param name="topmenu" value="0" />
<ui:param name="labelstyle" value="width:160px" />


<ui:define name="naveg">
	<div class="item">
		<s:link value="#{messages['cases']}" view="/cases/index.html" propagation="none"/>
	</div>
	<div class="item">
		<s:link value="#{messages['cases.searchresult']}" view="/cases/searchresult.xhtml" />
	</div>
	<div class="item selected">
		<s:link value="#{messages[tbcase.classification.key]}" view="/cases/searchresult.xhtml" />
	</div>
</ui:define>



<ui:define name="left">
	<h:panelGroup id="leftmenu" >
	<h:form class="vertical-menu">

	<h:commandLink action="#{caseHome.remove}" 
		onclick="if (!confirm('#{messages['form.confirm_remove']}')) return false;" 
		rendered="#{caseHome.canRemoveCaseData}">
		<div class="delete-icon"/><span>#{messages['form.remove']}</span>
	</h:commandLink>

	<s:link view="/cases/casehistory.xhtml" rendered="#{s:hasRole('LOGREP')}">
		<f:param name="id" value="#{caseHome.id}" />
		<div class="icon-report" style="float:none;" /><span>#{messages['form.logreport']}</span>
	</s:link>

	<s:link value="#{messages['cases.close']}" view="/cases/closecase.xhtml" rendered="#{caseHome.canClose}">
		<f:param name="id" value="#{caseHome.id}" />
	</s:link>
	
	<s:link onclick="showModalAutoTop('selclassificationdlg');return false;" rendered="#{tbcase.state=='WAITING_TREATMENT' or tbcase.state=='ONTREATMENT' or tbcase.state=='TRANSFERRING'}"
		value="#{messages['cases.changeNotifClass']}"/>

	<h:commandLink value="#{messages['cases.reopen']}" action="#{caseCloseHome.reopenCase}"
		rendered="#{caseHome.canReopen}" 
		onclick="if (!confirm('#{messages['cases.reopen.confirm']}')) return false;">
	</h:commandLink>
	
	<s:link view="/custom/br/reports/casedata.xhtml" target="_new">
		#{messages['global.print']}
		<f:param name="id" value="#{caseHome.id}" />
	</s:link>

	<s:link value="#{messages['admin.tags']}" view="/cases/casetagsedt.xhtml" rendered="#{caseHome.canTagCase and empty tbcase.tags}">
		<f:param name="id" value="#{caseHome.id}" />
	</s:link>
	
	<s:link value="#{messages['Boletim de Acompanhamento']}" view="/custom/br/cases/followupformedt.xhtml" rendered="#{caseHome.canInsertFollowUpForm}">
		<f:param name="id" value="#{caseHome.id}" />
	</s:link>
	
	</h:form>
	</h:panelGroup>


	<s:fragment rendered="#{facesContext.renderResponse and not empty tbcase.tags}">
	<table class="table2">
	<tr>
		<th>#{messages['admin.tags']}</th>
	</tr>
	<tr>
		<td>
		<a:repeat value="#{tbcase.tags}" var="it">
			<div class="tag-#{it.type}-icon"/>#{it.name}<br/>
		</a:repeat>
		</td>
	</tr>
	<s:fragment rendered="#{caseHome.canTagCase}">
	<tr>
		<th>
		<s:link value="#{messages['form.edit']}" 
			rendered="#{caseHome.canEditCaseData}" 
			view="/cases/casetagsedt.xhtml">
			<f:param name="id" value="#{caseHome.id}"/>
		</s:link>
		</th>
	</tr>
	</s:fragment>
	</table>
	</s:fragment>

	<div class="spacer" />
	
	<s:decorate template="/layout/roundrect.xhtml" style="margin-top:10px;" rendered="#{not empty caseHome.otherCases}">
		<ui:define name="header">
			<b>#{messages['cases.details.others']} #{tbcase.patient.name}</b>
		</ui:define>
		<ui:param name="showfooter" value="0" />
		
		<h:dataTable id="taboc" value="#{caseHome.otherCases}" var="it" style="font-size:10px;" 
			columnClasses="coll" width="100%">
			<h:column>
				<div onclick="openWaitDlg();location.href='#{request.contextPath}/cases/casedata.seam?id=#{it.id}';" style="cursor:pointer;">
				<b style="color:green;font-size:12px;width:100%;text-decoration: underline;">#{messages[it.classification.key]}
				</b>
				<br/>
				#{it.notificationUnit.name}
				<p/>
				<b>#{messages['TbCase.registrationDate']}:</b><br/> <h:outputText value="#{it.registrationDate}" converter="localeDateConverter" />
				<p/>
				<b>#{messages['CaseState']}:</b><br/> #{messages[it.state.key]}
				<hr style="margin-bottom:16px;" />
				</div>
			</h:column>
		</h:dataTable>
		<rich:jQuery selector="#taboc tr" 
                query="mouseover(function(){jQuery(this).addClass('sel-row')})"/>
		<rich:jQuery selector="#taboc tr" 
                query="mouseout(function(){jQuery(this).removeClass('sel-row')})"/>
	</s:decorate>
</ui:define>



<ui:define name="content">
<h1>#{title}</h1>
<h:form id="main">
<s:decorate id="bodydiv" template="/layout/casebody.xhtml">

	<ui:define name="casenumber">
		<a:commandLink value="Modificar número" styleClass="small-link"
			rendered="#{s:hasRole('CASE_CHANGENUMBER')}" 
			style="padding-left:20px" onclick="Richfaces.showModalPanel('caseNumberDlg');return false;" />
	</ui:define>

<ui:define name="state-content">
	<s:fragment rendered="#{tbcase.state=='TRANSFERRING'}" > 
	<div style="margin-top:6px;font-size:11px;max-width:320px;height:60px;" >
		<b style="padding-right:4px;">#{messages['meds.movs.destunit']}:</b> 
		<div class="icon-hu"/><h:outputText value="#{caseHome.transferInHealthUnit.tbunit.name}" />
		<br/>
		<span class="right-icon" />
		<div class="vertical-menu">
		<s:link value="#{messages['cases.move.regtransferin']}" view="/cases/casetransferin.xhtml" 
			propagation="none">
			<f:param name="id" value="#{caseHome.id}" />
		</s:link>
		<a:commandLink value="#{messages['cases.move.cancel']}"
			onclick="if (!confirm('#{caseMoveHome.confirmMsgRollbackTransfer}')) return false"
			action="#{caseMoveHome.rollbackTransferOut()}">
			<f:param name="name" value="#{caseHome.transferInHealthUnit.tbunit.name}"/>
		</a:commandLink>
		</div>
	</div>
	</s:fragment>
</ui:define>

<ui:include src="issues.xhtml" />


<div class="spacer" />

<rich:tabPanel switchType="client" id="tabCase">
<rich:tab label="#{messages['cases.details.case']}" id="tab1" ontabenter="updateTab(1)">
	<h:panelGroup id="pnltab1">
		<s:decorate template="data.xhtml" rendered="#{caseFilters.caseTab==1}"/>
	</h:panelGroup>
</rich:tab>

<rich:tab label="#{messages['cases.details.exams']}" id="tab2" ontabenter="updateTab(2)">
	<h:panelGroup id="pnltab2">
		<s:decorate template="exams.xhtml" rendered="#{caseFilters.caseTab==2}"/>
	</h:panelGroup>
</rich:tab>

<rich:tab label="#{messages['cases.details.medexam']}" id="tab4" ontabenter="updateTab(4)">
	<h:panelGroup id="pnltab4">
		<s:decorate template="medexamination.xhtml" rendered="#{caseFilters.caseTab==4}"/>
	</h:panelGroup>
</rich:tab>

<rich:tab label="#{messages['cases.details.otherinfo']}" id="tab5" ontabenter="updateTab(5)">
	<h:panelGroup id="pnltab5">
		<s:decorate template="/custom/br/cases/otherinfo.xhtml" rendered="#{caseFilters.caseTab==5}"/>
	</h:panelGroup>
</rich:tab>

<rich:tab label="#{messages['cases.details.treatment']}" id="tab3" ontabenter="updateTab(3)">
	<h:panelGroup id="pnltab3">
		<s:decorate template="/custom/br/cases/treatment.xhtml" rendered="#{caseFilters.caseTab==3}"/>
	</h:panelGroup>
</rich:tab>

<rich:tab label="#{messages['cases.details.report1']}" id="tab6" ontabenter="updateTab(6)">
	<h:panelGroup id="pnltab6">
		<s:decorate template="drugogram.xhtml" rendered="#{caseFilters.caseTab==6}"/>
	</h:panelGroup>
</rich:tab>

</rich:tabPanel>


<a:jsFunction name="updateTabContent" reRender="pnltab#{caseFilters.caseTab}">
	<a:actionparam name="param1" assignTo="#{caseFilters.caseTab}" converter="javax.faces.Integer" />
</a:jsFunction>
<a:jsFunction name="updateTabSelection">
	<a:actionparam name="param1" assignTo="#{caseFilters.caseTab}" converter="javax.faces.Integer" />
</a:jsFunction>
<script type="text/javascript">
<!--
window.tabLoaded = new Array();
window.inicasetab = #{caseFilters.caseTab};
jQuery().ready(function() {
	initTab();
});
function initTab() {
	var updt=window.inicasetab==0;
	if (updt)
		window.inicasetab=1;
	var tabid = 'tab' + window.inicasetab;
	var dest = 'main:bodydiv:tab' + window.inicasetab;
	RichFaces.switchTab('main:bodydiv:tabCase', dest, tabid);
	if (updt)
		updateTab(window.inicasetab);
}

function updateTab(tabIndex) {
	if (window.tabLoaded[tabIndex]==undefined) {
		window.updateTabContent(tabIndex);
		window.tabLoaded[tabIndex]=1;
	}
	else updateTabSelection(tabIndex);
}
-->
</script>






</s:decorate>	

</h:form>

<rich:modalPanel id="caseNumberDlg" width="500" autosized="true" zindex="2000" trimOverlayedElements="false" rendered="#{s:hasRole('CASE_CHANGENUMBER')}">
	<f:facet name="header">Modificar número do caso</f:facet>
	<ui:param name="labelstyle" value="width:110px" />
	<h:panelGroup id="periodpnl">
	<h:form style="padding:10px;">

	<h:messages globalOnly="true" styleClass="error" layout="table" />

	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">Novo número do paciente:</ui:define>
		<h:inputText value="#{caseHome.newPatientNumber}"  style="width:80px" />
	</s:decorate>

	<s:decorate template="/layout/edit.xhtml">
		<ui:define name="label">Díigito do caso:</ui:define>
		<h:inputText value="#{caseHome.newCaseNumber}" style="width:40px" />
	</s:decorate>

	<div class="button-bar">	
	<a:commandLink value="#{messages['form.ok']}" action="#{caseHome.changeNumber}"
		styleClass="button" reRender="main"
		onclick="if (!disableButton(this)) return false;"  
		oncomplete="Richfaces.hideModalPanel('caseNumberDlg');"/>

	<a:commandLink value="#{messages['form.cancel']}" styleClass="button-alt"  
		onclick="Richfaces.hideModalPanel('caseNumberDlg'); return false;"/>
	</div>
	
	</h:form>
	</h:panelGroup>
</rich:modalPanel>

<rich:modalPanel id="selclassificationdlg" width="300" zindex="2000" autosized="true">
	<f:facet name="header" >
		#{messages['cases.changeNotifClass']}
	</f:facet>

	<h:form id="formclassifcation">

	#{messages['cases.newnotif.title']}
	<div class="vertical-menu">
	<c:forEach items="#{globalLists.caseClassifications}" var="it">
		<!--<s:link view="/cases/newnotif.xhtml" rendered="#{userSession.isCanEditCaseByClassification(it)}">
			<f:param name="cla" value="#{it}"/>
			<f:param name="type" value="CONFIRMED"/>
			<div class="new-icon" />#{messages[it.key]}
		</s:link>-->
		<a:commandLink onclick="Richfaces.hideModalPanel('selclassificationdlg');" 
			action="#{caseDataBRHome.changeCaseClassification(it)}" value="#{messages[it.key]}" reRender="main, leftmenu, messages"/>
	</c:forEach>
	</div>
	<div class="button-bar">
		<s:link onclick="Richfaces.hideModalPanel('selclassificationdlg');return false;" 
			styleClass="button-alt" >
			<span>#{messages['form.cancel']}</span>
		</s:link>
	</div>
	</h:form>
</rich:modalPanel>

</ui:define>


</ui:composition>  