<?xml version="1.0" encoding="UTF-8"?> 
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
 	  			xmlns:a="https://ajax4jsf.dev.java.net/ajax"
                xmlns:s="http://jboss.com/products/seam/taglib"
                xmlns:rich="http://richfaces.ajax4jsf.org/rich">

	<div class="form-content">
	<h2>#{messages['cases.patientdata']}</h2>

	<table width="100%" style="border-collapse:collapse;">
	<tr><td colspan="2">
	<s:decorate template="/layout/editname.xhtml">
    	<ui:define name="label">#{messages['Patient.name']}:</ui:define>
		<ui:param name="patientdata" value="#{tbcasebd.patient}" />
		<ui:param name="required" value="#{true}" />
	</s:decorate>
	
	</td></tr>
	<tr><td>
	
	<s:decorate template="/layout/edit.xhtml" rendered="#{tbcasebd.diagnosisType=='CONFIRMED'}">
    	<ui:define name="label">#{messages['Patient.securityNumber']}:</ui:define>
		<h:inputText value="#{tbcasebd.patient.securityNumber}" style="width:120px;" maxlength="50"></h:inputText>
	</s:decorate>
	
	</td><td>
	
	<s:decorate template="/layout/edit.xhtml">
    	<ui:define name="label">#{messages['Gender']}:</ui:define>
    	<h:selectOneMenu value="#{tbcasebd.patient.gender}" required="true">
    		<s:selectItems value="#{genders}" var="it" label="#{messages[it.key]}" noSelectionLabel="-"/>
    		<s:convertEnum />
    	</h:selectOneMenu>
	</s:decorate>
	
	</td></tr>
	
	<ui:include src="/custom/bd/layout/editbirthdate.xhtml" />
	
	<tr><td>
	<s:decorate template="/layout/edit.xhtml">
    	<ui:define name="label">#{messages['Patient.fatherName']}:</ui:define>
		<h:inputText value="#{tbcasebd.patient.fatherName}" style="width:300px;" maxlength="100" />
	</s:decorate>
	
	</td>
	
	<td>
	<s:decorate template="/layout/edit.xhtml">
    	<ui:define name="label">#{messages['Patient.motherName']}:</ui:define>
		<h:inputText value="#{tbcasebd.patient.motherName}" style="width:300px;" maxlength="100" />
	</s:decorate>
	
	</td></tr>
	<tr><td>
	
    <s:decorate template="/layout/edit.xhtml" >
    	<ui:define name="label">#{messages['Nationality']}:</ui:define>
    	<h:selectOneMenu value="#{tbcasebd.nationality}">
    		<s:selectItems var="s" value="#{nationalities}" noSelectionLabel="-" label="#{messages[s.key]}"/>
    		<s:convertEnum />
    	</h:selectOneMenu>
    </s:decorate>

	</td></tr>    
    
    <tr><td colspan="2">
    	<div class="paragraph">#{messages['cases.details.addressnotif']}</div>
    </td></tr>
    
    <tr><td colspan="2">
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['Address.address']}:</ui:define>
    		<h:inputText value="#{tbcasebd.notifAddress.address}" style="width:300px" required="true" maxlength="100"/>
    	</s:decorate>
    	
    </td></tr>
    
    <tr><td colspan="2">
    	<s:decorate template="/layout/edit.xhtml">
    		<h:inputText value="#{tbcasebd.notifAddress.complement}" style="width:300px" maxlength="100"/>
    	</s:decorate>
    </td></tr>

	<tr><td>
		<s:decorate template="/layout/auselection.xhtml">
			<ui:param name="auselection" value="#{caseEditingHome.notifAdminUnit}" />
		</s:decorate>
    </td></tr>

    <tr><td>
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['Address.zipCode']}</ui:define>
    		<h:inputText value="#{tbcasebd.notifAddress.zipCode}" maxlength="20" />
    	</s:decorate>
    </td></tr>

    <tr><td colspan="2">
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:param name="labelstyle" value="width:400px;" />
    		<ui:define name="label">#{messages['tbcase.notifAddressChanged']}:</ui:define>
    		<h:selectOneMenu id="addrChanged" value="#{tbcasebd.notifAddressChanged}" >
    			<f:selectItem itemLabel="#{messages['global.no']}" itemValue="#{false}"/>
    			<f:selectItem itemLabel="#{messages['global.yes']}" itemValue="#{true}"/>
    		</h:selectOneMenu>
    	</s:decorate>
    	
    	<div id="curraddr" style="clear:both;">
    	<div class="paragraph">#{messages['cases.details.addresscurr']}</div>
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['Address.address']}:</ui:define>
    		<h:inputText value="#{tbcasebd.currentAddress.address}" style="width:300px;margin-bottom:2px;" maxlength="100"/><br/>
    		<h:inputText value="#{tbcasebd.currentAddress.complement}" style="width:300px" maxlength="100"/>
    	</s:decorate>

    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['Address.zipCode']}</ui:define>
    		<h:inputText value="#{tbcasebd.currentAddress.zipCode}" maxlength="20" />
    	</s:decorate>
    	
    	<table width="100%" style="border-collapse: collapse;">
		<tr><td>
			<s:decorate template="/layout/auselection.xhtml">
				<ui:param name="auselection" value="#{caseEditingHome.currentAdminUnit}" />
				<ui:param name="required" value="false" />
			</s:decorate>
    	</td></tr>
    	</table>
    	<hr/>
    	</div>
    </td></tr>

	<tr><td>
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['tbcase.phoneNumber']}:</ui:define>
    		<h:inputText value="#{tbcasebd.phoneNumber}" />
    	</s:decorate>	
	</td><td>
    	<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['tbcase.mobileNumber']}:</ui:define>
    		<h:inputText value="#{tbcasebd.mobileNumber}" />
    	</s:decorate>	
    
    </td></tr>
    <tr>
		<td>
	    	<s:decorate template="/layout/edit.xhtml">
	    		<ui:define name="label">#{messages['Patient.occupation']}:</ui:define>
		    	<h:selectOneMenu value="#{tbcasebd.occupation}">
		    		<s:selectItems value="#{occupationList}" var="it" label="#{messages[it.key]}" noSelectionLabel="-"/>
		    		<s:convertEnum />
		    	</h:selectOneMenu>
	    	</s:decorate>	
	    
	    </td>    
	    <td>
	    	<s:decorate template="/layout/edit.xhtml">
	    		<ui:define name="label">#{messages['Patient.salary']}:</ui:define>
		    	<h:selectOneMenu value="#{tbcasebd.salary}">
		    		<s:selectItems value="#{salaryRangeList}" var="it" label="#{messages[it.key]}" noSelectionLabel="-"/>
		    		<s:convertEnum />
		    	</h:selectOneMenu>
	    	</s:decorate>	
	    
	    </td>
	  </tr>
    </table>
	</div>


	<div class="form-content">
	<h2>#{messages['cases.generaldata']}</h2>

	<table width="100%" style="border-collapse:collapse;">
	<tr><td style="padding-bottom:10px;">

	<div class="paragraph">#{messages['cases.details.notifhu']}</div>
	<s:decorate template="/layout/tbselection.xhtml" >
		<ui:param name="tbunitselection" value="#{caseEditingHome.tbunitselection}" />
		<ui:param name="required" value="true" />
	</s:decorate>

	</td></tr><tr><td>

	<div id="divregdate">
    <s:decorate template="/layout/dateedit.xhtml" >
    	<ui:define name="label">#{messages['TbCase.registrationDate']}:</ui:define>
    	<ui:param name="datefield" value="#{tbcasebd.registrationDate}" /> 
		<ui:param name="required" value="true" />
		<ui:param name="edtid" value="regdateedt" />
		<ui:param name="checkDeathDate" value="true" />
		<ui:param name="future" value="false" />
    </s:decorate>
    </div>
    <rich:jQuery selector="#divregdate input" query="bind('keypress', function() { handleCaseDateChange();})" />

	<!--
	<a:region>
    <s:decorate template="/layout/edit.xhtml" rendered="#{caseHome.managed}">
    	<ui:define name="label">#{messages['DiagnosisType']}:</ui:define>
    	<h:selectOneMenu value="#{tbcasebd.diagnosisType}" required="true">
    		<s:selectItems var="it" value="#{diagnosisTypes}" noSelectionLabel="-" label="#{messages[it.key]}"/>
    		<s:convertEnum />
    		<a:support event="onchange" reRender="main" />
    	</h:selectOneMenu>
	    <a:status id="suspstatus" >
	    	<f:facet name="start">
	    		<div class="wait-icon2" />
	    	</f:facet>
	    </a:status> 
    </s:decorate>
    </a:region>
    -->

	<s:fragment rendered="#{tbcasebd.diagnosisType=='CONFIRMED'}">
    <s:decorate template="/layout/dateedit.xhtml" >
    	<ui:define name="label">#{messages['TbCase.diagnosisDate']}:</ui:define>
    	<ui:param name="required" value="true" /> 
    	<ui:param name="datefield" value="#{tbcasebd.diagnosisDate}" /> 
    	<ui:param name="edtid" value="diagdateedt" />
    	<ui:param name="checkDeathDate" value="true" />
		<ui:param name="future" value="false" />
    </s:decorate>

    <s:decorate template="/layout/edit.xhtml" rendered="#{tbcasebd.classification=='DRTB'}">
    	<ui:define name="label">#{messages['DrugResistanceType']}:</ui:define>
    	<h:selectOneMenu value="#{tbcasebd.drugResistanceType}" >
    		<s:selectItems var="it" value="#{drugResistanceTypes}" noSelectionLabel="-" label="#{messages[it.key]}"/>
    		<s:convertEnum />
    	</h:selectOneMenu>
    </s:decorate>

    <s:decorate template="/layout/edit.xhtml" rendered="#{tbcase.classification=='TB'}" id="patType1Dec">
        <ui:define name="label">#{messages['PatientType']}:</ui:define>
        <h:selectOneMenu id="patType1" value="#{tbcase.patientType}" required="#{true}">
            <s:selectItems var="it" value="#{patientTypesTB}" noSelectionLabel="-" label="#{messages[it.key]}" />
            <s:convertEnum />
        </h:selectOneMenu>
    </s:decorate>

    <div id="prevTreatType" style="#{tbcase.patientType != 'PREVIOUSLY_TREATED' ? 'display:none' : ''}">
        <s:decorate template="/layout/edit.xhtml" id="prevTreatTypeDec">
            <ui:define name="label">#{messages['PatientType.PREVIOUSLY_TREATED']}:</ui:define>
            <ui:param name="redasterisk" value="#{true}"/>
            <h:selectOneMenu value="#{tbcase.previouslyTreatedType}" id="previouslyTreatedType">
                <s:selectItems var="it" value="#{prevTreatedTypes}" noSelectionLabel="-" label="#{messages[it.key]}" />
                <s:convertEnum />
            </h:selectOneMenu>
        </s:decorate>
    </div>

    <rich:jQuery selector="#patType1" query="change(function(){ showPrevTreatType(this); })" />
    <rich:jQuery selector="#patType2" query="change(function(){ showPatientTypeOther(this); })" />

    <s:decorate template="/layout/edit.xhtml" rendered="#{tbcase.classification=='DRTB'}">
        <ui:define name="label">#{messages['PatientType']}:</ui:define>
        <h:selectOneMenu id="patType2" value="#{tbcase.patientType}" required="#{true}">
            <s:selectItems var="it" value="#{patientTypesDRTB}" noSelectionLabel="-" label="#{messages[it.key]}" />
            <s:convertEnum />
        </h:selectOneMenu>
    </s:decorate>

		<div id="patientTypeOther" style="#{tbcase.patientType != 'OTHER' ? 'display:none' : ''}">
		<s:decorate template="/layout/edit.xhtml">
			<ui:define name="label">#{messages['TbCase.patientTypeOther']}</ui:define>
    		<h:inputText value="#{tbcasebd.patientTypeOther}" style="width:200px;" maxlength="100" />
		</s:decorate>
		</div>

		<s:decorate template="/layout/edit.xhtml">
    		<ui:define name="label">#{messages['InfectionSite']}:</ui:define>
    		<h:selectOneMenu id="infectsite" value="#{tbcasebd.infectionSite}" required="#{true}">
    			<s:selectItems var="it" value="#{infectionSite_bd}" noSelectionLabel="-" label="#{messages[it.key]}" />
    			<s:convertEnum />
    		</h:selectOneMenu>
		</s:decorate>

<rich:jQuery selector="#infectsite" query="change(function(){showExtrapulmonary(this); })" />
<script type="text/javascript">
<!--
function isPatientTypeOther(cb) {
    return ((cb.selectedIndex >= 0) && (cb.options[cb.selectedIndex].value == 'OTHER'));
}
function isPatientTypePrevTreat(cb) {
    return ((cb.selectedIndex >= 0) && (cb.options[cb.selectedIndex].value == 'PREVIOUSLY_TREATED'));
}
function showPatientTypeOther(cb) {
    if (isPatientTypeOther(cb))
        jQuery('#patientTypeOther').show(500);
    else jQuery('#patientTypeOther').hide(500);
}
function showPrevTreatType(cb) {
    if (isPatientTypePrevTreat(cb))
        jQuery('#prevTreatType').show(500);
    else{
        document.getElementById('main:prevTreatTypeDec:previouslyTreatedType').options[0].selected = "true";
        jQuery('#prevTreatType').hide(500);
    }
}
function isExtrapulmonary(cb) {
	return ((cb.selectedIndex == 2) || (cb.selectedIndex == 3));
}

function isPulmonary(cb) {
	return ((cb.selectedIndex == 1) || (cb.selectedIndex == 3));
}

function showExtrapulmonary(cb) {
	if (isExtrapulmonary(cb))
		jQuery('#extrapul').show(500);
	else{
		document.getElementById('main:edtextrapdec:edtextrapfldoptions').options[0].selected = "true";
		document.getElementById('main:edtextrap2dec:edtextrap2fldoptions').options[0].selected = "true";
		document.getElementById('extrapul').style.display = "none";
	}

	if (isPulmonary(cb))
		jQuery('#pulmonary').show(500);
	else{
		document.getElementById('main:pulmonaryTypeDec:pulmonarybd').options[0].selected = "true";
		document.getElementById('pulmonary').style.display = "none";

		document.getElementById('main:pulmonaryTypesDec:pulmonaryTypes').options[0].selected = "true";
		document.getElementById('pulmonary2').style.display = "none";
	}
}

function showRefToDetails(cb) {
	if (cb.selectedIndex!=0)
		jQuery('#refToFields').show(500);
	else{
		document.getElementById('main:refToUnitdec:reftounitdec:reftounit').value = '';
		document.getElementById('main:refToUnitdec:dt:edtdateInputDate').value = '';
		jQuery('#refToFields').hide(500);
	}
}

-->
</script>

	<div id="extrapul" style="clear:both;">
		<div style="float:left">
			<s:decorate template="/layout/editfield.xhtml" id="edtextrapdec">
				<ui:define name="label">#{messages['TbField.EXTRAPULMONARY_TYPES']}:</ui:define>
				<ui:param name="id" value="edtextrap" />
				<ui:param name="field" value="#{tbcasebd.extrapulmonaryType}" />
				<ui:param name="list" value="#{fieldsQuery.extrapulmonaryTypes}" />
				<ui:param name="required" value="#{false}" />
			</s:decorate>
		</div>

		<div style="float:left">
			<s:decorate template="/layout/editfield.xhtml" id="edtextrap2dec">
				<ui:define name="label">#{messages['TbField.EXTRAPULMONARY_TYPES']}(2):</ui:define>
				<ui:param name="id" value="edtextrap2" />
				<ui:param name="field" value="#{tbcasebd.extrapulmonaryType2}" />
				<ui:param name="list" value="#{fieldsQuery.extrapulmonaryTypes}" />
				<ui:param name="required" value="#{false}" />
			</s:decorate>
		</div>
	</div>

	<div id="pulmonary" style="clear:both;">
		<s:decorate template="/layout/edit.xhtml" id="pulmonaryTypeDec">
    		<ui:define name="label">#{messages['TbField.PULMONARY_TYPES']}:</ui:define>
    		<h:selectOneMenu id="pulmonarybd" value="#{tbcasebd.pulmonaryTypesBD}" style="margin-right:4px;">
    			<s:selectItems var="it" value="#{pulmonaryTypesBD}" noSelectionLabel="-" label="#{messages[it.key]}" />
    			<s:convertEnum />
    		</h:selectOneMenu>
    	</s:decorate>
    </div>
 
 <rich:jQuery selector="#pulmonarybd" query="change(function(){showPulmonaryTypes(this); })" />   	
 <script type="text/javascript">
 <!--
function showPulmonaryTypes(cb){
	if(cb.selectedIndex == 2)
		jQuery('#pulmonary2').show(500);
	else{
		document.getElementById('main:pulmonaryTypesDec:pulmonaryTypes').options[0].selected = "true";
		jQuery('#pulmonary2').hide(500);
	}
}
 -->
 </script>	
 
 	<div id="pulmonary2" style="clear:both;">  
 		<s:decorate template="/layout/edit.xhtml" id="pulmonaryTypesDec">
    		<h:selectOneMenu id="pulmonaryTypes" value="#{tbcasebd.pulmonaryType}" style="margin-right:4px;">
    			<s:selectItems var="it" value="#{fieldOptions.pulmonaryTypes}" noSelectionLabel="-" label="#{it}" />
    			<s:convertEntity />
    		</h:selectOneMenu>
		</s:decorate>
	</div>

<rich:jQuery selector="#infectsite" query="each(function(){ if (!isExtrapulmonary(this)) {jQuery('#extrapul').hide(); }})" />
<rich:jQuery selector="#infectsite" query="each(function(){ if (!isPulmonary(this)) {jQuery('#pulmonary').hide(); }})" />
<rich:jQuery selector="#patType" query="each(function(){ if (!isPatientTypeOther(this)) {jQuery('#patientTypeOther').hide(); }})" />
<rich:jQuery selector="#infectsite" query="each(function(){ if (!isPulmonary(this)) {jQuery('#pulmonary2').hide(); }})" />
<rich:jQuery selector="#pulmonarybd" query="each(function(){showPulmonaryTypes(this)})" />

		</s:fragment>		
		</td></tr></table>

    <s:decorate template="/layout/edit.xhtml" id="refToUnitdec">
        <ui:define name="label">#{messages['MedicalExamination.ReferredTo']}:</ui:define>
        <h:selectOneMenu id="cbrefto" required="true" value="#{tbcasebd.patientRefToFv}" style="margin-right:4px;" onchange="showRefToDetails(this)">
            <s:selectItems var="it" value="#{fieldsQuery.refToTypes}" noSelectionLabel="-" label="#{it}" />
            <s:convertEntity />
        </h:selectOneMenu>

        <div id="refToFields">
            <s:decorate template="/layout/edit.xhtml" id="reftounitdec">
                <ui:define name="label">#{messages['MedicalExamination.RefToUnit']}:</ui:define>
                <ui:param name="labelstyle" value="width:auto; text-align:left" />
                <h:inputText id="reftounit" value="#{tbcasebd.referredToUnitName}" style=" width : 340px;" maxlength="100"/>
            </s:decorate>

            <s:decorate id="dt" template="/layout/dateedit.xhtml">
                <ui:define name="label">#{messages['MedicalExamination.RefToDate']}:</ui:define>
                <ui:param name="labelstyle" value="width:auto; text-align:left" />
                <ui:param name="required" value="false" />
                <ui:param name="future" value="true" />
                <ui:param name="datefield" value="#{tbcasebd.refToDate}" />
				<ui:param name="id" value="reftodate"/>
            </s:decorate>
        </div>

    </s:decorate>

    <rich:jQuery selector="#cbrefto" query="change(function(){showRefToFields(this); })" />
    <rich:jQuery selector="#cbrefto" query="each(function(){ if (this.selectedIndex==0) jQuery('#refToFields').hide(); })" />

    <script type="text/javascript">
        function showRefToFields(ashow) {
            if (ashow.selectedIndex != 0)
                jQuery('#refToFields').show(500);
            else jQuery('#refToFields').hide(500);
        }
    </script>

    </div>


	<div class="form-content">
		<h2>#{messages['cases.prevtreat']}</h2>

		<table width="100%" style="border-collapse:collapse;"><tr><td>
		<s:decorate template="/layout/edit.xhtml">
			<ui:define name="label">
				#{messages['cases.prevtreat.numprev']}:
			</ui:define>
			<h:selectOneMenu value="#{prevTBTreatmentHome.numTreatments}">
				<f:selectItems value="#{prevTBTreatmentHome.numTreatmentsOptions}"/>
				<a:support event="onchange" ajaxSingle="true" reRender="prevtreats"/>
			</h:selectOneMenu>
		</s:decorate>

		<h:panelGroup id="prevtreats">
		<s:fragment rendered="#{prevTBTreatmentHome.numTreatments>0}">
		<table width="98%" class="table1 small">
			<tr>
				<th rowspan="2">#{messages['cases.prevtreat.num']}
				</th>
				<th rowspan="2">#{messages['cases.prevtreat.date']}
				</th>
				<th colspan="#{prevTBTreatmentHome.substances.size}">
					#{messages['cases.prevtreat.regs']}
				</th>
				<th rowspan="2">#{messages['PrevTBTreatment.outcome']} - #{messages['form.monthyear']}
				</th>
			</tr>
			<tr>
			<a:repeat value="#{prevTBTreatmentHome.substances}" var="s">
				<th>#{s.abbrevName}
				</th>
			</a:repeat>
			</tr>
		<a:repeat value="#{prevTBTreatmentHome.treatments}" var="it">
			<tr>
				<td class="colcb">#{it.index}
				</td>
				<td class="colcb">
					<h:selectOneMenu value="#{it.prevTBTreatment.month}">
						<f:selectItems value="#{months}"/>
					</h:selectOneMenu>
					<s:validateAll>
						<h:selectOneMenu id="year" value="#{it.prevTBTreatment.year}" required="true">
							<f:selectItems value="#{years}"/>
						</h:selectOneMenu>
					</s:validateAll>
					<h:message for="year" styleClass="error"/>
				</td>
				<a:repeat value="#{it.items}" var="sub">
				<td class="colcb">
					<h:selectBooleanCheckbox value="#{sub.selected}" />
				</td>
				</a:repeat>
				<td class="colcb">
					<s:validateAll>
					<h:selectOneMenu id="oc" value="#{it.prevTBTreatment.outcome}" required="true">
						<s:selectItems var="v" value="#{globalLists_bd.getPrevTBTreatmentOutcomes()}" label="#{messages[v.key]}" noSelectionLabel="-" />
						<s:convertEnum />
					</h:selectOneMenu>
					</s:validateAll>
					<h:message for="oc" styleClass="error"/>
					
					<h:selectOneMenu value="#{it.prevTBTreatment.outcomeMonth}">
						<f:selectItems value="#{months}"/>
					</h:selectOneMenu>
					<s:validateAll>
						<h:selectOneMenu id="outcomeyear" value="#{it.prevTBTreatment.outcomeYear}">
							<f:selectItems value="#{years}"/>
						</h:selectOneMenu>
					</s:validateAll>
					<h:message for="outcomeyear" styleClass="error"/>
				</td>
			</tr>
		</a:repeat>
		</table>
		</s:fragment>
		</h:panelGroup>
		</td></tr></table>
	</div>

<rich:jQuery selector="#addrChanged" query="change(function(){ showCurrAddress(this); })" />
<script type="text/javascript">
function showCurrAddress(cb) {
  if (cb.selectedIndex == 0)
  	jQuery('#curraddr').hide(500);
  else jQuery('#curraddr').show(500);
}
</script>
<rich:jQuery selector="#addrChanged" query="each(function(){ if (this.selectedIndex==0) jQuery('#curraddr').hide(); })" />

		
</ui:composition>