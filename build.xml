<?xml version="1.0" encoding="UTF-8" standalone="no"?> 

<project basedir="." default="build" name="etbmanager"
	xmlns:sonar="antlib:org.sonar.ant">

	<property environment="env" />
	<property file="build.properties" />
	<property name="war-file-name" value="etbmanager.war" />
	<property name="implementation-title" value="e-TB Manager" />
    <property name="debuglevel" value="source,lines,vars"/>
    <property name="target" value="1.6"/>
    <property name="source" value="1.6"/>

	<path id="project.libraryclasspath">
        <pathelement location="WebContent/WEB-INF/lib/commons-beanutils.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/commons-digester.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/commons-lang.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/drools-compiler.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/drools-core.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-el.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-ioc.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-mail.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-pdf.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-remoting.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-ui.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jsf-facelets.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-api-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-impl-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-ui-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jxl.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/gson-2.1.jar"/>
	 	<pathelement location="WebContent/WEB-INF/lib/gwt-servlet.jar"/>
	 	<pathelement location="WebContent/WEB-INF/lib/${lib.datastream}"/>
	 	<pathelement location="WebContent/WEB-INF/lib/commons-io-2.4.jar"/>
		<pathelement location="WebContent/WEB-INF/lib/commons-fileupload-1.3.jar"/>
		<pathelement location="WebContent/WEB-INF/lib/quartz.jar"/>
		<pathelement location="WebContent/WEB-INF/lib/itext-4.2.0.jar"/>
	 	<pathelement location="WebContent/WEB-INF/classes"/>
    </path>


	<path id="jboss-4.2.3.GA.libraryclasspath">
        <pathelement location="${jboss.dir}/client/commons-logging.jar"/>
        <pathelement location="${jboss.dir}/server/default/deploy/jboss-web.deployer/jsf-libs/jsf-api.jar"/>
        <pathelement location="${jboss.dir}/server/default/deploy/jboss-web.deployer/jsf-libs/jsf-impl.jar"/>
        <pathelement location="${jboss.dir}/server/default/deploy/ejb3.deployer/jboss-ejb3.jar"/>
        <pathelement location="${jboss.dir}/client/jboss-j2ee.jar"/>
        <pathelement location="${jboss.dir}/client/ejb3-persistence.jar"/>
        <pathelement location="${jboss.dir}/client/servlet-api.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/hibernate-annotations.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/hibernate-entitymanager.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/hibernate-core.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/lucene-core.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/hibernate-search.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/hibernate-validator.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/dom4j.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/axis.jar"/>
        <pathelement location="${jboss.dir}/server/default/lib/jboss-jaxrpc.jar"/>
    </path>
	
	<path id="gwt.librarypath">
        <pathelement location="${gwt.dir}/gwt-dev.jar"/>
        <pathelement location="${gwt.dir}/gwt-user.jar"/>
	</path>
	
	<path id="google.closure-compiler">
	    <pathelement location="${google.closure-compiler.dir}/compiler.jar" />
	</path>

	<path id="mdrtb.classpath">
        <pathelement location="build/classes"/>
        <path refid="project.libraryclasspath"/> 
        <path refid="jboss-4.2.3.GA.libraryclasspath"/>
        <path refid="gwt.librarypath"/>
    </path>
	
	<path id="etbm.sourcepath">
		<pathelement location="src/action"/>
		<pathelement location="src/model"/>
		<pathelement location="src/client"/>
		<pathelement location="src/reports"/>
	</path>

	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask"
	    classpath="${google.closure-compiler.dir}/compiler.jar" >
	</taskdef>
	

	<target name="init">
		<echo message="Implementation title  :  ${implementation-title}" />
		<echo message="Implementation version:  ${implementation-version}" />
		<echo message="Implementation vendor :  ${implementation-vendor}" />
		<echo message="war file              :  ${war-file-name}" />
		
        <mkdir dir="build/classes"/>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/action" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/model" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/ph" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/ua" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/in" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
        <copy includeemptydirs="false" todir="build/classes">
            <fileset dir="src/kh" excludes="**/*.launch, **/*.java, **/*.html"/>
        </copy>
    </target>
    
	<target name="clean">
        <delete dir="build/classes"/>
    </target>
    
	<target depends="clean" name="cleanall"/>
	
	
    <target depends="compile,gwt-compile,javascript-compile,war" name="build" />
	
	<target depends="init" name="compile">
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="true" debuglevel="${debuglevel}" destdir="build/classes" source="${source}" target="${target}" encoding="8859_1">
           <src path="src/action"/>
           <src path="src/model"/>
 		   <src path="src/reports"/>
 		   <src path="src/client"/>
	       <src path="src/md"/>
	       <src path="src/uz"/>
	       <src path="src/ng"/>
           <src path="src/bd"/>
           <src path="src/na"/>
	       <src path="src/ke"/>
           <src path="src/in"/>
           <src path="src/kh"/>
	       <src path="src/vi"/>
	       <src path="src/kh"/>
           <classpath refid="mdrtb.classpath"/>
		 </javac>
    </target>

	
	<target description="Build all projects which reference this project. Useful to propagate changes." name="build-refprojects"/>
	
	
	<target description="Build the .war file" depends="init" name="war">
		<delete file="build/${war-file-name}" />
		<buildnumber file="build.num"/>
		
		<tstamp>
			<format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
		</tstamp>
		
		<manifest file="WebContent/META-INF/MANIFEST.MF">
			<attribute name="Built-By" value="${user.name}"/>
			<attribute name="Implementation-Version" value="${implementation-version}-b${build.number}"/>
			<attribute name="Implementation-Title" value="${implementation-title}"/>
			<attribute name="Implementation-Vendor" value="${implementation-vendor}"/>
			<attribute name="Built-Date" value="${TODAY}"/>
			<attribute name="Build-Jdk" value="${java.version}" />
		</manifest>
		<echo message="Build number          :  ${build.number}" />

		<copy file="production/web.xml" todir="build" overwrite="true" />
		<replace file="build/web.xml" token="@liquibase_context@" value="" />

		<war destfile="build/${war-file-name}" webxml="build/web.xml" manifest="WebContent/META-INF/MANIFEST.MF">
			<fileset dir="WebContent" >
				<exclude name="WEB-INF/web.xml"/>
				<exclude name="WEB-INF/components.xml" />
				<exclude name="WEB-INF/classes/META-INF/persistence.xml" />
				<exclude name="WEB-INF/deploy/**"/>
			</fileset>
			
			<classes dir="build/classes">
				<exclude name="META-INF/persistence.xml"/>
			</classes>
			
			<zipfileset file="production/persistence.xml" prefix="WEB-INF/classes/META-INF" />
			<zipfileset file="production/components.xml" prefix="WEB-INF" />
			<zipfileset file="build/compiled/commons.min.${commons.js.checksum}.js" prefix="public/js" />
		</war>
	</target>


	<target name="javascript-compile" description="Compile static java-script files to reduce its size">
	    <mkdir dir="build/compiled" /> 
	    <jscomp compilationLevel="simple" warning="default" debug="false" output="build/compiled/commons.min.js">
	        <sources dir="${basedir}/WebContent/public/js" >
	            <file name="commons.js" />
	        </sources>
	    </jscomp>
	    <checksum file="build/compiled/commons.min.js" property="commons.js.checksum" />
	    <move file="build/compiled/commons.min.js" tofile="build/compiled/commons.min.${commons.js.checksum}.js" />
	</target> 
	

	<target name="gwt-compile" description="Compile java source code in javascript code using GWT">
		<java failonerror="true" fork="true" classname="com.google.gwt.dev.Compiler" >
			<classpath>
				<pathelement location="src/client" />
				<path refid="gwt.librarypath" />
			</classpath>
			<jvmarg value="-Xmx512M"/>
			<arg value="-style"/>
			<arg value="OBFUSCATED" />
			<arg value="-logLevel"/>
			<arg value="INFO" />
			<arg value="-war"/>
			<arg value="WebContent" />
			<arg value="org.msh.tb.client.reports"/>
		</java>
	</target>

		
	<target name="doc" depends="init" description="JavaDoc generation">
		<javadoc destdir="${doc.dir}" sourcepathref="etbm.sourcepath" classpathref="mdrtb.classpath"
			author="true"
			version="true">
			<doclet name="org.umlgraph.doclet.UmlGraphDoc" path="WebContent/WEB-INF/lib/UMLGraph.jar">
       	        <param name="-attributes" />
       	        <param name="-operations" />
       	        <param name="-qualify" />
       	        <param name="-types" />
       	        <param name="-visibility" />
			</doclet>
			
			<doctitle><![CDATA[<h1>eTB Manager Javadoc</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; 2005 Management Sciences for Health, Inc. All Rights Reserved.</i>]]></bottom>
		</javadoc>
		<apply executable="dot" dest="${doc.dir}" parallel="false">
		    <arg value="-Tpng"/>
		    <arg value="-o"/>
		    <targetfile/>
		    <srcfile/>
		    <fileset dir="${doc.dir}" includes="*.dot"/>
		    <mapper type="glob" from="*.dot" to="*.png"/>
		</apply>
	</target>


	<!-- Define the Sonar global properties (the most usual way is to pass these properties via the command line) -->
	<property name="sonar.jdbc.url" value="jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8" />
	<property name="sonar.jdbc.username" value="root" />
	<property name="sonar.jdbc.password" value="admin" />
	<property name="sonar.host.url" value="http://localhost:9000/sonar" />
	<property name="sonar.login" value="admin" />
	<property name="sonar.password" value="admin" />
	<property name="sonar.forceAuthentication" value="true" />

	<!-- Define the Sonar project properties -->
	<property name="sonar.projectKey" value="etbmanager" />
	<property name="sonar.projectName" value="eTB Manager" />
	<property name="sonar.projectVersion" value="2.0" />
	<property name="sonar.modules" value="java-module,xml-module" />
	<property name="sonar.sources" value="src/action,src/model,src/ng,src/na,src/bd,src/ke,src/uz" />

	<property name="java-module.sonar.projectName" value="Java Module" />
	<property name="java-module.sonar.language" value="java" />
	<property name="java-module.sonar.sources" value="src/action,src/model,src/ng,src/na,src/bd,src/ke,src/uz" />
	<property name="java-module.sonar.binaries" value="build" />
	<property name="java-module.sonar.projectBaseDir" value="/" />

	<property name="xml-module.sonar.projectName" value="XML Module" />
	<property name="xml-module.sonar.language" value="xml" />
	<property name="xml-module.sonar.sources" value="WebContent,resources,production" />
	<property name="xml-module.sonar.binaries" value="build" />
	<property name="xml-module.sonar.projectBaseDir" value="/" />

	<!-- Define the Sonar target -->
	<target name="sonar">
	    <taskdef uri="antlib:org.sonar.ant" resource="org/sonar/ant/antlib.xml">
	    </taskdef>
		 
	    <!-- Execute Sonar -->
	    <sonar:sonar />
	</target>
</project>
