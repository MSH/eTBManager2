<?xml version="1.0" encoding="UTF-8" standalone="no"?> 

<project basedir="." default="build" name="etbmanager"
	xmlns:sonar="antlib:org.sonar.ant">
    <property environment="env" />
	<property file="build.properties" />
	<property name="war-file-prefix" value="etbmanager" />
	<property name="implementation-title" value="e-TB Manager for Azerbaijan" />
	<property name="country-code" value="AZ" />
	<property name="country-folder" value="az" />
	<property name="country" value="Azerbaijan" />
    <property name="debuglevel" value="source,lines,vars"/>
    <property name="target" value="1.6"/>
    <property name="source" value="1.6"/>
    <property name="build-classes" value="build/classes-country"/>


	<path id="project.libraryclasspath">
        <pathelement location="WebContent/WEB-INF/lib/commons-beanutils.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/commons-digester.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/commons-lang.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/drools-compiler.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/drools-core.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-el.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-ioc.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-mail.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-pdf.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-remoting.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam-ui.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jboss-seam.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jsf-facelets.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-api-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-impl-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/richfaces-ui-3.3.3.Final.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/jxl.jar"/>
        <pathelement location="WebContent/WEB-INF/lib/gson-2.1.jar"/>
		<pathelement location="WebContent/WEB-INF/lib/eidssAz.jar"/>
		<pathelement location="WebContent/WEB-INF/lib/gwt-servlet.jar"/>
        <pathelement location="WebContent/WEB-INF/classes"/>
    </path>


	<path id="jboss-4.2.3.GA.libraryclasspath">
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/client/commons-logging.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/deploy/jboss-web.deployer/jsf-libs/jsf-api.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/deploy/jboss-web.deployer/jsf-libs/jsf-impl.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/deploy/ejb3.deployer/jboss-ejb3.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/client/jboss-j2ee.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/client/ejb3-persistence.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/client/servlet-api.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/hibernate-annotations.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/hibernate-entitymanager.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/hibernate-core.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/lucene-core.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/hibernate-search.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/hibernate-validator.jar"/>
        <pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/dom4j.jar"/>
		<pathelement location="C:\JBoss\jboss-4.2.3.GA/server/default/lib/quartz.jar"/>
    </path>

	<path id="gwt.librarypath">
        <pathelement location="c:\gwt\gwt-2.4.0/gwt-dev-2.4.0.jar"/>
        <pathelement location="c:\gwt\gwt-2.4.0/gwt-user-2.4.0.jar"/>
	</path>

	<path id="mdrtb.classpath">
        <pathelement location="${build-classes}"/>
		<path refid="project.libraryclasspath"/> 
        <path refid="jboss-4.2.3.GA.libraryclasspath"/>
		<path refid="gwt.librarypath"/>
    </path>

	<path id="etbm.sourcepath">
		<pathelement location="src/action"/>
		<pathelement location="src/model"/>
		<pathelement location="src/client"/>
		<pathelement location="src/reports"/>
	</path>
	
	<target name="init">
		<echo message="Implementation title  :  ${implementation-title}" />
		<echo message="Implementation version:  ${implementation-version}" />
		<echo message="Implementation vendor :  ${implementation-vendor}" />
		
        <mkdir dir="${build-classes}"/>
		<delete dir="${build-classes}" />
        <copy includeemptydirs="false" todir="${build-classes}">
            <fileset dir="src/action" excludes="**/*.launch, **/*.java"/>
        </copy>
        <copy includeemptydirs="false" todir="${build-classes}">
            <fileset dir="src/model" excludes="**/*.launch, **/*.java"/>
        </copy>
        <copy includeemptydirs="false" todir="${build-classes}">
            <fileset dir="src/${country-folder}" excludes="**/*.launch, **/*.java"/>
        </copy>
    </target>

	

	<target name="clean">
        <delete dir="${build-classes}"/>
    </target>

	

	<target depends="clean" name="cleanall"/>
	
	
    <target depends="compile,gwt-compile,war" name="build" />

	

	<target depends="init" name="compile">
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="false" debuglevel="${debuglevel}" destdir="${build-classes}" source="${source}" target="${target}" encoding="8859_1">
            <src path="src/model"/>
            <src path="src/action"/>
        	<src path="src/reports"/>
        	<src path="src/client"/>
            <src path="src/${country-folder}"/>
            <classpath refid="mdrtb.classpath"/>
        </javac>
    </target>

	
	<target description="Build all projects which reference this project. Useful to propagate changes." name="build-refprojects"/>
	
	
	<target description="Build the .war file" depends="init" name="war">
		<property name="war-file-name" value="${war-file-prefix}-${implementation-version}-${country-code}.war" />
		<echo message="war file              :  ${war-file-name}" />
		<delete file="build/${war-file-name}" />
		<buildnumber file="build/build.num"/>
		
		<tstamp>
			<format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
		</tstamp>
		
		<manifest file="WebContent/META-INF/MANIFEST.MF">
			<attribute name="Built-By" value="${user.name}"/>
			<attribute name="Implementation-Version" value="${implementation-version}-b${build.number}"/>
			<attribute name="Implementation-Title" value="${implementation-title}"/>
			<attribute name="Implementation-Vendor" value="${implementation-vendor}"/>
			<attribute name="Built-Date" value="${TODAY}"/>
			<attribute name="Build-Jdk" value="${java.version}" />
			<attribute name="Country-Code" value="${country-code}" />
			<attribute name="Country" value="${country}" />
		</manifest>

		<war destfile="build/${war-file-name}" webxml="production/web.xml" manifest="WebContent/META-INF/MANIFEST.MF">
			<fileset dir="WebContent" >
				<include name="**" />
				<exclude name="WEB-INF/web.xml"/>
				<exclude name="WEB-INF/components.xml" />
				<exclude name="WEB-INF/faces-config.xml" />
				<exclude name="custom/**"/>
			</fileset>
			
			<fileset dir="WebContent">
				<include name="custom/${country-folder}/**" />
			</fileset>

			<classes dir="${build-classes}">
				<exclude name="META-INF/persistence.xml"/>
				<exclude name="/messages*" />
				<exclude name="/custom_messages*" />
			</classes>
			
			<zipfileset file="src/model/messages_en.properties" fullpath="WEB-INF/classes/messages_en.properties" />
			<zipfileset file="src/model/messages_az_AZ.properties" fullpath="WEB-INF/classes/messages_az_AZ.properties" />
			<zipfileset file="src/model/custom_messages_az_AZ.properties" fullpath="WEB-INF/classes/custom_messages_az_AZ.properties" />
			<zipfileset file="src/model/messages_ru.properties" fullpath="WEB-INF/classes/messages_ru.properties" />
			<zipfileset file="WebContent/WEB-INF/seam.quartz.properties" fullpath="WEB-INF/classes/seam.quartz.properties" />
			<zipfileset file="production/persistence.xml" prefix="WEB-INF/classes/META-INF" />
			<zipfileset file="production/components.xml" prefix="WEB-INF" />
			<zipfileset file="production/az/faces-config.xml" fullpath="WEB-INF/faces-config.xml" />
			<!-- okurasov 30.01.12 to determine virtual host -->
			<zipfileset file="production/az/jboss-web.xml" fullpath="WEB-INF/jboss-web.xml" />
		</war>
	</target>
	
	<target name="doc" depends="init" description="JavaDoc generation">
			<javadoc destdir="${doc.dir}" sourcepathref="etbm.sourcepath" classpathref="mdrtb.classpath"
				author="true"
				version="true">
				<doclet name="org.umlgraph.doclet.UmlGraphDoc" path="WebContent/WEB-INF/lib/UMLGraph.jar">
	       	        <param name="-attributes" />
	       	        <param name="-operations" />
	       	        <param name="-qualify" />
	       	        <param name="-types" />
	       	        <param name="-visibility" />
				</doclet>
				
				<doctitle><![CDATA[<h1>eTB Manager Javadoc</h1>]]></doctitle>
				<bottom><![CDATA[<i>Copyright &#169; 2005 Management Sciences for Health, Inc. All Rights Reserved.</i>]]></bottom>
			</javadoc>
			<apply executable="dot" dest="${doc.dir}" parallel="false">
			    <arg value="-Tpng"/>
			    <arg value="-o"/>
			    <targetfile/>
			    <srcfile/>
			    <fileset dir="${doc.dir}" includes="*.dot"/>
			    <mapper type="glob" from="*.dot" to="*.png"/>
			</apply>
		</target>



		<target name="gwt-compile" description="Compile java source code in javascript code using GWT">
			<java failonerror="true" fork="true" classname="com.google.gwt.dev.Compiler" >
				<classpath>
					<pathelement location="src/client" />
					<path refid="gwt.librarypath" />
				</classpath>
				<jvmarg value="-Xmx512M"/>
				<arg value="-style"/>
				<arg value="OBFUSCATED" />
				<arg value="-logLevel"/>
				<arg value="INFO" />
				<arg value="-war"/>
				<arg value="WebContent" />
				<arg value="org.msh.tb.client.reports"/>
			</java>
		</target>



		<!-- Define the Sonar global properties (the most usual way is to pass these properties via the command line) -->
		<property name="sonar.jdbc.url" value="jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8" />
		<property name="sonar.jdbc.username" value="root" />
		<property name="sonar.jdbc.password" value="admin" />
		<property name="sonar.host.url" value="http://localhost:9000/sonar" />
		<property name="sonar.login" value="admin" />
		<property name="sonar.password" value="admin" />
		<property name="sonar.forceAuthentication" value="true" />

		<!-- Define the Sonar project properties -->
		<property name="sonar.projectKey" value="etbmanager" />
		<property name="sonar.projectName" value="eTB Manager" />
		<property name="sonar.projectVersion" value="2.0" />
		<property name="sonar.modules" value="java-module,xml-module" />
		<property name="sonar.sources" value="src/action,src/model,src/ng,src/na,src/bd,src/ke,src/br,src/ua,src/az,src/uz" />

		<property name="java-module.sonar.projectName" value="Java Module" />
		<property name="java-module.sonar.language" value="java" />
		<property name="java-module.sonar.sources" value="src/action,src/model,src/ng,src/na,src/bd,src/ke,src/br,src/ua,src/az,src/uz" />
		<property name="java-module.sonar.binaries" value="build" />
		<property name="java-module.sonar.projectBaseDir" value="/" />

		<property name="xml-module.sonar.projectName" value="XML Module" />
		<property name="xml-module.sonar.language" value="xml" />
		<property name="xml-module.sonar.sources" value="WebContent,resources,production" />
		<property name="xml-module.sonar.binaries" value="build" />
		<property name="xml-module.sonar.projectBaseDir" value="/" />

		<!-- Define the Sonar target -->
		<target name="sonar">
		    <taskdef uri="antlib:org.sonar.ant" resource="org/sonar/ant/antlib.xml">
		    </taskdef>
			 
		    <!-- Execute Sonar -->
		    <sonar:sonar />
		</target>
	
</project>
