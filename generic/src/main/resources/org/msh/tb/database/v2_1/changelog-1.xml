<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="v2.1cs1" author="rmemoria">
        <sql>
            update userrole
            set code = concat('0', code + 10000)
            where code >= '020000'
        </sql>

        <insert tableName="userrole">
            <column name="id" valueNumeric="220"/>
            <column name="changeable" valueBoolean="false" />
            <column name="code" value="020000"/>
            <column name="role_name" value="LAB_MODULE" />
            <column name="internalUse" valueBoolean="false" />
            <column name="byCaseClassification" valueBoolean="false" />
            <column name="messageKey" value="userrole.LAB_MODULE" />
        </insert>

        <insert tableName="userrole">
            <column name="id" valueNumeric="221"/>
            <column name="changeable" valueBoolean="false" />
            <column name="code" value="020100"/>
            <column name="role_name" value="LAB_NEWREQUEST" />
            <column name="internalUse" valueBoolean="false" />
            <column name="byCaseClassification" valueBoolean="false" />
            <column name="messageKey" value="labs.newreq" />
        </insert>

        <insert tableName="userrole">
            <column name="id" valueNumeric="222"/>
            <column name="changeable" valueBoolean="false" />
            <column name="code" value="020200"/>
            <column name="role_name" value="LAB_POSTRESULT" />
            <column name="internalUse" valueBoolean="false" />
            <column name="byCaseClassification" valueBoolean="false" />
            <column name="messageKey" value="userrole.LAB_POSTRESULT" />
        </insert>

        <insert tableName="userrole">
            <column name="id" valueNumeric="223"/>
            <column name="changeable" valueBoolean="false" />
            <column name="code" value="020300"/>
            <column name="role_name" value="LAB_EDTREQ" />
            <column name="internalUse" valueBoolean="false" />
            <column name="byCaseClassification" valueBoolean="false" />
            <column name="messageKey" value="userrole.LAB_EDTREQ" />
        </insert>

        <insert tableName="userrole">
            <column name="id" valueNumeric="224"/>
            <column name="changeable" valueBoolean="false" />
            <column name="code" value="020400"/>
            <column name="role_name" value="LAB_REMREQ" />
            <column name="internalUse" valueBoolean="false" />
            <column name="byCaseClassification" valueBoolean="false" />
            <column name="messageKey" value="userrole.LAB_REMREQ" />
        </insert>
    </changeSet>

    <changeSet id="v2.1cs2" author="rmemoria">
        <delete tableName="userrole">
            <where>id=199</where>
        </delete>

        <!-- Insert the permission to all administrator profiles -->
        <sql>
            INSERT INTO userpermission(canchange, canexecute, grantPermission, profile_id, role_id)
            select false, true, true, prof.id, role.id
            from userprofile prof
            inner join userrole role on role.id in (220,221,222,223,224)
            where prof.name like 'Administr%';

            update userrole set messageKey='labs' where id=220;
        </sql>
    </changeSet>

    <!-- Start changing the model for the laboratory module -->
    <changeSet id="v2.1cs3" author="rmemoria">
        <!-- Create the patient sample table -->
        <createTable tableName="patientsample">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" />
            </column>
            <column name="dateCollected" type="date">
                <constraints nullable="false" />
            </column>
            <column name="sampleNumber" type="varchar(50)"></column>
            <column name="comments" type="text"></column>
            <column name="sampleType" type="int"></column>
            <column name="case_id" type="int">
                <constraints nullable="false" />
            </column>
            <column name="request_id" type="int"></column>
        </createTable>

        <createTable tableName="examrequest">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" />
            </column>
            <column name="requestDate" type="date">
                <constraints nullable="false" />
            </column>
            <column name="unit_id" type="int"></column>
            <column name="user_id" type="int">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="FK_samplecase" baseTableName="patientsample" baseColumnNames="case_id"
                                 referencedTableName="tbcase" referencedColumnNames="id" onDelete="CASCADE" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="FK_samplerequest" baseTableName="patientsample" baseColumnNames="request_id"
                                 referencedTableName="examrequest" referencedColumnNames="id" onDelete="SET NULL" onUpdate="CASCADE"/>

        <!-- Link the patient sample to the exams -->
        <addColumn tableName="examdst">
            <column name="sample_id" type="int"></column>
        </addColumn>

        <addColumn tableName="exammicroscopy">
            <column name="sample_id" type="int"></column>
        </addColumn>

        <addColumn tableName="examculture">
            <column name="sample_id" type="int"></column>
        </addColumn>

        <addColumn tableName="examxpert">
            <column name="sample_id" type="int"></column>
        </addColumn>

        <addForeignKeyConstraint constraintName="FK_micsample" baseTableName="exammicroscopy" baseColumnNames="sample_id"
                                 referencedTableName="patientsample" referencedColumnNames="id" onDelete="SET NULL" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="FK_cultsample" baseTableName="examculture" baseColumnNames="sample_id"
                                 referencedTableName="patientsample" referencedColumnNames="id" onDelete="SET NULL" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="FK_xpertsample" baseTableName="examxpert" baseColumnNames="sample_id"
                                 referencedTableName="patientsample" referencedColumnNames="id" onDelete="SET NULL" onUpdate="CASCADE"/>

        <addForeignKeyConstraint constraintName="FK_dstsample" baseTableName="examdst" baseColumnNames="sample_id"
                                 referencedTableName="patientsample" referencedColumnNames="id" onDelete="SET NULL" onUpdate="CASCADE"/>
    </changeSet>


    <changeSet id="v2.1_cs4" author="">
        <sqlFile path="org/msh/tb/database/v2_1/update_schema_patientsample.sql" />

        <dropColumn tableName="exammicroscopy" columnName="sampleNumber" />
        <dropColumn tableName="exammicroscopy" columnName="dateCollected" />

        <dropColumn tableName="examculture" columnName="sampleNumber" />
        <dropColumn tableName="examculture" columnName="dateCollected" />

        <dropColumn tableName="examdst" columnName="sampleNumber" />
        <dropColumn tableName="examdst" columnName="dateCollected" />

        <dropColumn tableName="examxpert" columnName="sampleNumber" />
        <dropColumn tableName="examxpert" columnName="dateCollected" />
    </changeSet>

    <!-- Add status column to the exams -->
    <changeSet id="v2.1.cs4" author="rmemoria">
        <addColumn tableName="examculture">
            <column name="status" type="int"></column>
        </addColumn>
        <addColumn tableName="exammicroscopy">
            <column name="status" type="int"></column>
        </addColumn>
        <addColumn tableName="examdst">
            <column name="status" type="int"></column>
        </addColumn>
        <addColumn tableName="examxpert">
            <column name="status" type="int"></column>
        </addColumn>
    </changeSet>
</databaseChangeLog>