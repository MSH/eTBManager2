<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:s="http://jboss.com/products/seam/taglib"
 	  xmlns:a="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.ajax4jsf.org/rich"
      template="/layout/template_new.xhtml">

<ui:param name="title" value="#{messages['meds.movs.newadjust']}" />
<ui:param name="topmenu" value="1" />
<ui:param name="pagestyle" value="width:750px" />

<ui:define name="head">
	<a:loadScript src="util.js" />
</ui:define>


<ui:define name="left">
</ui:define>

<ui:define name="naveg" >
	<s:link value="#{messages['meds.inventory']}" view="/medicines/index.html" propagation="none" />
	<div class="item selected">
		<s:link value="#{title}" />
	</div>
</ui:define>

<ui:define name="content">
<div style="width:800px">
<s:decorate template="/layout/unitsel.xhtml">
<h:form id="main">
	<a:commandLink onclick="newBatchDlg();" style="float:right;" styleClass="button-alt">
		<span>#{messages['meds.receiving.newbatch']}...</span>
	</a:commandLink>

    <s:decorate template="/layout/display.xhtml" >
    	<ui:define name="label">#{messages['Source']}:</ui:define>
    	<h:selectOneMenu value="#{stockAdjustmentHome.source}">
    		<s:selectItems var="s" value="#{sources}" label="#{s}" noSelectionLabel="-"/>
    		<s:convertEntity />
    		<a:support event="onchange" reRender="main" ajaxSingle="true" onsubmit="openWaitDlg();" oncomplete="closeWaitDlg();" action="#{stockAdjustmentHome.sourceChanged()}"/>
    	</h:selectOneMenu>
    </s:decorate>


<h:panelGroup id="pnlitems">
<s:fragment rendered="#{stockAdjustmentUAHome.items.size()>0}">
<table id="medlist" width="100%" class="table1">
	<tr><th width="350px">
			#{messages['Medicine']}
		</th>
		<th width="150px"><h:outputText value="#{messages['Batch.expiryDate']}" styleClass="colch" /></th>	
		<th width="150px"><h:outputText value="#{messages['Batch.numContainers']}" styleClass="colrh" /></th>	
		<th width="150px"><h:outputText value="#{messages['meds.movs.availableqtty']}" styleClass="colrh" /></th>	
		<th width="140px"><h:outputText value="#{messages['form.action']}" styleClass="colch" /></th>
	</tr>
<a:repeat value="#{stockAdjustmentUAHome.items}" var="it">
	<tr class="med">
		<td colspan="5">
			<div id="med-row" style="height:30px;min-height:30px;">
			<div style="float:left;width:450px;">
				<a:commandLink value="#{messages['form.details']}" style="float:right;" onclick="detailsClick(this);return false;" />
				<div class="medicine-icon" />
				<s:span styleClass="alert-icon" rendered="#{stockAdjustmentHome.checkExpiringBatch(it)}"/>
				<s:span styleClass="icon-error" rendered="#{stockAdjustmentHome.checkExpiredBatch(it)}"/>
				<h:outputText value="#{it.stockPosition.medicine}" />
			</div>
			<div style="float:left;width:140px;text-align:right;">
				<h:outputText value="#{it.stockPosition.quantity}" style="#{it.stockPosition.quantity>0?'font-weight:bold;':''}">
					<f:convertNumber pattern="#,###,###,##0"/>
				</h:outputText>
			</div>
			</div>

		<div id="tblbatch" style="display:none;">					
		<a:repeat value="#{it.batches}" var="b">
			<s:fragment rendered="#{b.quantity != 0}">
				<div style="clear:both;position:relative;min-height:40px;height:40px;border-top:1px solid #d0d0d0;padding-top:4px;#{b.batch.expired ? 'color:red' : (medCalcCont.isExpiringBatch(b) ? 'color:#D7620B' : '')}">
					<div style="float:right;width:107px;">
						<a:commandLink value="#{messages['form.edit']}" 
							style="float:right;margin-right:37px;"
							styleClass="right-icon small-link" 
							onclick="initBatchEditing(#{b.id},#{it.stockPosition.id})"/>					
						<br/>
						<a:commandLink value="#{messages['meds.movs.delbatch']}" 
							style="float:right;"
							styleClass="right-icon small-link" 
							onclick="initBatchDeleting(#{b.id})"/>
					</div>
					<div style="float:left;width:230px;padding-left:30px;">
						<s:decorate template="/custom/ua/layout/batch.xhtml" >
							<ui:param name="batch" value="#{b.batch}" />
						</s:decorate>
					</div>
					<div style="float:left;width:130px;text-align:center;">
						<h:outputText value="#{b.batch.expiryDate}" converter="localeDateConverter" />
					</div>
					<div style="float:left;width:130px;text-align:right;">
						<h:outputText value="#{b.batch.numContainers} (â„–#{b.batch.quantityContainer})"/>
					</div>
					<div style="float:left;width:130px;text-align:right;">
						<h:outputText value="#{b.quantity}">
							<f:convertNumber pattern="#,###,##0"/>
						</h:outputText>
					</div>
				</div>
			</s:fragment>
		</a:repeat>
		</div>
			
		</td>
	</tr>
</a:repeat>
</table>
</s:fragment>

<rich:jQuery selector="#medlist tr:odd" query="addClass('lin1')" />
<rich:jQuery selector="#medlist tr:even" query="addClass('lin2')" />
</h:panelGroup>


<a:jsFunction name="initBatchEditingDlg" reRender="batchdlgcontent" ajaxSingle="true"
	action="#{stockAdjustmentHome.initializeBatchAdjustment}" >
	<a:actionparam name="param1" assignTo="#{stockAdjustmentHome.batchQuantityId}" converter="javax.faces.Integer" />
	<a:actionparam name="param2" assignTo="#{stockAdjustmentHome.stockPositionId}" converter="javax.faces.Integer" />
</a:jsFunction>

<a:jsFunction name="initBatchDeletingDlg" reRender="delbatchpnl" ajaxSingle="true">
	<a:actionparam name="param1" assignTo="#{stockAdjustmentHome.batchQuantityId}" converter="javax.faces.Integer" />
</a:jsFunction>

<a:jsFunction name="refreshMedTable" reRender="pnlitems" ajaxSingle="true" />
<a:jsFunction name="refreshNewBatchDlg" reRender="pnlitems,batchdlgcontent" ajaxSingle="true" />

<a:jsFunction name="initNewBatchDlg" reRender="batchdlgcontent"	ajaxSingle="true" action="#{stockAdjustmentHome.clearBatch()}"/>

</h:form>
</s:decorate>
</div>          

<s:decorate template="/layout/batchselection.xhtml">
	<ui:param name="quantitytitle" value="#{messages['meds.movs.newqtty']}" />

	<ui:define name="before-form">
		<h:inputHidden value="#{stockAdjustmentHome.stockPositionId}" />
		<s:decorate template="/layout/editfield.xhtml" >
	   		<ui:define name="label">#{messages['TbField.ADJUSTMENT']}:</ui:define>
	    	<ui:param name="required" value="true" />
	    	<ui:param name="id" value="adjInfo" />
	   		<ui:param name="field" value="#{stockAdjustmentHome.adjustmentInfo}" />
	   		<ui:param name="list" value="#{fieldsQuery.adjustmentType}" />
	   		<ui:param name="labelstyle" value="width:130px" />
	    </s:decorate>
	</ui:define>

	<a:commandLink action="#{stockAdjustmentHome.executeBatchAdjustment}"
		data="#{stockAdjustmentHome.actionExecuted}"  
		onclick="if (!disableButton(this)) return false;if (!validateBatchSelection(this)) {enableButton();return false;}" 
		oncomplete="enableButton();if (!data) return false; hideBatchesSelectionDlg();refreshMedTable();" 
		reRender="batchselpnl,messages" styleClass="button">
		<span>#{messages['form.ok']}</span>
	</a:commandLink>

</s:decorate>

<script type="text/javascript">
<!--
waitdiv = '<div style="float:left" class="wait-icon"/>';
function detailsClick(elem) {
	var tbl=jQuery(elem).closest("td").find("#tblbatch");
	var bVisible=jQuery(tbl).is(":visible");
	tbl.slideToggle(500);
	if (bVisible)
		 jQuery(elem).text('#{messages['form.details']}');
	else jQuery(elem).text('#{messages['form.hidedetails']}');
	
}
function initBatchEditing(batchId,spId) {
	jQuery('#tblsel').html(waitdiv);
	Richfaces.showModalPanel('batchdlg');
	initBatchEditingDlg(batchId,spId);
}

function initNewBatch() {
	cleanB();
	jQuery('#tblsel').html(waitdiv);
	Richfaces.showModalPanel('batchdlg');
	initNewBatchDlg();	
}

function initBatchDeleting(batchId) {
	jQuery('#delbatchfields').html(waitdiv);
	Richfaces.showModalPanel('delbatchdlg');
	initBatchDeletingDlg(batchId);
}

-->
</script>


<rich:modalPanel id="delbatchdlg" width="650" zindex="2000" autosized="true">
	<f:facet name="header">
		<h:outputText value="#{messages['meds.movs.delbatch']}" />
	</f:facet>
	<h:panelGroup id="delbatchpnl">
	<a:region>
	<a:form>
    <table width="100%" style="border-collapse:collapse;">
    <tr><td colspan="2">
	<div id="delbatchfields">
	<h:inputHidden value="#{stockAdjustmentHome.batchQuantityId}" />	
	<s:decorate template="/layout/display.xhtml">
		<ui:define name="label">#{messages['Medicine']}:</ui:define>
		<ui:param name="labelstyle" value="width:130px" /> 
		#{stockAdjustmentHome.batchQuantity.batch.medicine}
	</s:decorate>

	<s:decorate template="/layout/display.xhtml">
		<ui:define name="label">#{messages['Batch.batchNumber']}:</ui:define>
		<ui:param name="labelstyle" value="width:130px" /> 
		#{stockAdjustmentHome.batchQuantity.batch.batchNumber}
	</s:decorate>

	<s:decorate template="/layout/display.xhtml">
		<ui:define name="label">#{messages['Batch.expiryDate']}:</ui:define>
		<ui:param name="labelstyle" value="width:130px" /> 
		<h:outputText value="#{stockAdjustmentHome.batchQuantity.batch.expiryDate}" converter="localeDateConverter" />
	</s:decorate>

	<s:decorate template="/layout/dateedit.xhtml" >
		<ui:define name="label">#{messages['meds.movs.outdate']}:</ui:define>
		<ui:param name="required" value="true" /> 
		<ui:param name="labelstyle" value="width:130px" /> 
		<ui:param name="datefield" value="#{stockAdjustmentHome.movementDate}" /> 
	</s:decorate>

	<s:decorate template="/layout/editfield.xhtml" >
   		<ui:define name="label">#{messages['TbField.ADJUSTMENT']}:</ui:define>
   		<ui:param name="labelstyle" value="width:130px" /> 
    	<ui:param name="required" value="true" />
    	<ui:param name="id" value="adjInfo" />
   		<ui:param name="field" value="#{stockAdjustmentHome.adjustmentInfo}" />
   		<ui:param name="list" value="#{fieldsQuery.adjustmentType}" />
    </s:decorate>

	</div>
	</td></tr>
    <tr><td>
			<span style="color:red;">*</span> #{messages['javax.faces.component.UIInput.REQUIRED']}
    		<ui:include src="/layout/waitstatus.xhtml" />
    	</td>
    	<td align="right">
            <a:commandLink action="#{stockAdjustmentUAHome.deleteBatch()}" styleClass="button" 
            	reRender="batchdlgcontent"
            	data="#{stockAdjustmentHome.actionExecuted}"
            	onclick="if (!disableButton(this)) return false;"
            	oncomplete="enableButton();if (!data) return false; Richfaces.hideModalPanel('delbatchdlg');refreshMedTable();">
            	<span>#{messages['form.ok']}</span>
            </a:commandLink>
			<s:link 
				styleClass="button-alt" 
				onclick="Richfaces.hideModalPanel('delbatchdlg'); return false;" >
				<span>#{messages['form.cancel']}</span>
			</s:link>
    </td></tr>
    
    </table>
    
	</a:form>
	</a:region>
	</h:panelGroup>
</rich:modalPanel>


<s:decorate template="/custom/ua/layout/batchselectionsingle.xhtml" id="batchsellayout">
	<ui:param name="homeClass" value="#{stockAdjustmentHome}" />
	<ui:param name="medicine" value="#{stockAdjustmentHome.batchQuantity.batch.medicine}" />
	<ui:param name="batch" value="#{stockAdjustmentHome.batchQuantity.batch}" />
	<ui:param name="quantityRec" value="#{stockAdjustmentHome.batchQuantity.batch.quantityReceived}" />
	<ui:param name="srcAnnexFunc" value="#{stockAdjustmentUAHome}" />
	<ui:param name="canEditing" value="true" />
	<ui:param name="canSelectMed" value="#{stockAdjustmentHome.batchQuantity.batch.batchNumber==null}" />
	<ui:param name="regNumbOnlyAdding" value="true" />
	
	<a:jsFunction name="cleanB" ajaxSingle="true" action="#{stockAdjustmentHome.clearBatch()}"/>
	<a:commandLink action="#{stockAdjustmentHome.saveBatch()}" styleClass="button" 
            	reRender="batchdlgcontent,messages"
            	data="#{stockAdjustmentHome.actionExecuted}"
            	onclick="if (!disableButton(this)) return false;if (!validateBatchSelection(this)) {enableButton();return false;}"
            	oncomplete="enableButton();if (!data) return false; Richfaces.hideModalPanel('batchdlg');refreshMedTable();"
            	style="display:#{stockAdjustmentHome.existingBatchInThisUnit ? 'none' : 'inline-block'}" >
            	<span>#{messages['form.ok']}</span>
    </a:commandLink>

</s:decorate>

</ui:define>

</ui:composition>  